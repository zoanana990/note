cscope 15 $HOME/CODE/note               0000097045
	@algorithm/graph/310.Minimum_Height_Tree/bfs.cpp

1 
	~<io¡»am
>

2 
	~<veùÜ
>

3 
	~<queue
>

5 
usšg
 
Çme¥aû
 
	g¡d
;

7 
	gveùÜ
<> 
fšdMšHeightT»es
(
n
, 
veùÜ
 <veùÜ<>> &
edges
) {

8 ià(
	gn
 == 1) {

13 
	gveùÜ
 <veùÜ<>> 
adjLi¡
(
n
);

14 
	gveùÜ
<> 
šDeg»e
(
n
, 0);

17 cÚ¡‡utØ&
	gedge
: 
edges
) {

18 
adjLi¡
[
edge
[0]].
push_back
(edge[1]);

19 
	gadjLi¡
[
edge
[1]].
push_back
(edge[0]);

20 
	gšDeg»e
[
edge
[0]]++;

21 
	gšDeg»e
[
edge
[1]]++;

25 
	gqueue
<> 
	gq
;

28 
	gi
 = 0; i < 
	gn
; ++i) {

29 ià(
	gšDeg»e
[
i
] == 1) {

30 
q
.
push
(
i
);

35 
	gcout
 << "Adjaûncy Li¡:" << 
	g’dl
;

36 
	gi
 = 0; i < 
	gn
; ++i) {

37 
	gcout
 << 
	gi
 << " -> ";

38 
	gÃighbÜ
: 
adjLi¡
[
i
]) {

39 
cout
 << 
ÃighbÜ
 << " ";

41 
	gcout
 << 
	g’dl
;

45 
	gn
 > 2) {

46 
	gsz
 = 
q
.
size
();

47 
	gn
 -ğ
sz
;

49 
	gi
 = 0; i < 
	gsz
; ++i) {

50 
	gnode
 = 
q
.
äÚt
();

51 
	gq
.
pİ
();

53 
	gÃighbÜ
: 
adjLi¡
[
node
]) {

54 ià(--
šDeg»e
[
ÃighbÜ
] == 1) {

55 
q
.
push
(
ÃighbÜ
);

62 
	gveùÜ
<> 
	g»suÉ
;

63 !
	gq
.
em±y
()) {

64 
	g»suÉ
.
push_back
(
q
.
äÚt
());

65 
	gq
.
pİ
();

68  
	g»suÉ
;

71 
	$maš
() {

73 
n
 = 6;

74 
veùÜ
 <veùÜ<>> 
edges
 = {{0, 3},

80 
veùÜ
<> 
»suÉ
 = 
	`fšdMšHeightT»es
(
n
, 
edges
);

83 
cout
 << "Minimum Height Trees'„oot†abels: ";

84 
roÙ
: 
»suÉ
) {

85 
cout
 << 
roÙ
 << " ";

87 
cout
 << 
’dl
;

90 
	}
}

	@algorithm/graph/332.Reconstruct Itinerary/greedy_dfs.cpp

1 şas 
	cSŞutiÚ
 {

2 
	mpublic
:

4 
dfs
(
unÜd”ed_m­
 <
¡ršg
, 
veùÜ
<¡ršg>> &
g¿ph
, sŒšg &
cu¼’t
, veùÜ <¡ršg> &
»suÉ
) {

5 !
	mg¿ph
[
cu¼’t
].
em±y
()) {

6 
¡ršg
 
	mÃxt
 = 
g¿ph
[
cu¼’t
].
back
();

7 
	mg¿ph
[
cu¼’t
].
pİ_back
();

8 
dfs
(
g¿ph
, 
Ãxt
, 
»suÉ
);

10 
	m»suÉ
.
push_back
(
cu¼’t
);

13 
	gveùÜ
 <
	g¡ršg
> 
fšdItš”¬y
(
veùÜ
 <veùÜ<
¡ršg
>> &
tick‘s
) {

14 
	gunÜd”ed_m­
 <
	g¡ršg
, 
	gveùÜ
<¡ršg>> 
	gg¿ph
;

17 cÚ¡‡utØ&
	gtick‘
: 
tick‘s
) {

18 
g¿ph
[
tick‘
[0]].
push_back
(ticket[1]);

20 
sÜt
(
g¿ph
[
tick‘
[0]].
begš
(), g¿ph[tick‘[0]].
’d
(), 
g»©”
<
¡ršg
>());

23 
	gveùÜ
 <
	g¡ršg
> 
	g»suÉ
;

24 
¡ršg
 
	g¡¬t
 = "JFK";

25 
dfs
(
g¿ph
, 
¡¬t
, 
»suÉ
);

27 
»v”£
(
»suÉ
.
begš
(),„esuÉ.
’d
());

28  
	g»suÉ
;

	@algorithm/graph/399.Evaluate_devision/bfs.cpp

1 şas 
	cSŞutiÚ
 {

2 
	mpublic
:

3 
veùÜ
<>

4 
ÿlcEqu©iÚ
(
veùÜ
 <veùÜ<
¡ršg
>> &
equ©iÚs
, veùÜ<> &
v®ues
, veùÜ <veùÜ<¡ršg>> &
qu”›s
) {

5 
	munÜd”ed_m­
 <
	m¡ršg
, unÜd”ed_m­<¡ršg, >> 
	mg¿ph
;

8 
	mi
 = 0; i < 
	mequ©iÚs
.
size
(); ++i) {

9 cÚ¡ 
	m¡ršg
 &
	mA
 = 
equ©iÚs
[
i
][0];

10 cÚ¡ 
	m¡ršg
 &
	mB
 = 
equ©iÚs
[
i
][1];

11 
	mv®ue
 = 
v®ues
[
i
];

13 
	mg¿ph
[
A
][
B
] = 
v®ue
;

14 
	mg¿ph
[
B
][
A
] = 1.0 / 
v®ue
;

18 
	mveùÜ
<> 
	m»suÉs
;

19 cÚ¡‡utØ&
	mqu”y
: 
qu”›s
) {

20 cÚ¡ 
¡ršg
 &
¡¬t
 = 
qu”y
[0];

21 cÚ¡ 
	m¡ršg
 &
	m’d
 = 
qu”y
[1];

23 ià(!
	mg¿ph
.
couÁ
(
¡¬t
è|| !g¿ph.couÁ(
’d
)) {

25 
	m»suÉs
.
push_back
(-1.0);

27 
	m»suÉ
 = 
bfs
(
g¿ph
, 
¡¬t
, 
’d
);

28 
	m»suÉs
.
push_back
(
»suÉ
);

32  
	m»suÉs
;

35 
	g´iv©e
:

36 
bfs
(
unÜd”ed_m­
 <
¡ršg
, unÜd”ed_m­<¡ršg, >> &
g¿ph
, cÚ¡ sŒšg &
¡¬t
, cÚ¡ sŒšg &
’d
) {

37 
	gqueue
 <
	g·œ
<
	g¡ršg
, >> 
	gq
;

38 
	gunÜd”ed_£t
 <
	g¡ršg
> 
	gvis™ed
;

40 
	gq
.
push
({
¡¬t
, 1.0});

41 
	gvis™ed
.
š£¹
(
¡¬t
);

43 !
	gq
.
em±y
()) {

44 autØ
	gäÚt
 = 
q
.
äÚt
();

45 
	gq
.
pİ
();

46 cÚ¡ 
	g¡ršg
 &
	gcu¼’t
 = 
äÚt
.
fœ¡
;

47 cÚ¡ 
	gcu¼’tProduù
 = 
äÚt
.
£cÚd
;

49 ià(
	gcu¼’t
 =ğ
’d
) {

50  
cu¼’tProduù
;

53 cÚ¡‡utØ&
	gÃighbÜ
: 
g¿ph
[
cu¼’t
]) {

54 cÚ¡ 
¡ršg
 &
Ãxt
 = 
ÃighbÜ
.
fœ¡
;

55 cÚ¡ 
	gedgeWeight
 = 
ÃighbÜ
.
£cÚd
;

57 ià(
	gvis™ed
.
fšd
(
Ãxt
è=ğ
vis™ed
.
’d
()) {

58 
q
.
push
({
Ãxt
, 
cu¼’tProduù
 * 
edgeWeight
});

59 
	gvis™ed
.
š£¹
(
Ãxt
);

	@algorithm/graph/399.Evaluate_devision/dfs.cpp

1 
	~<io¡»am
>

2 
	~<unÜd”ed_m­
>

3 
	~<unÜd”ed_£t
>

4 
	~<veùÜ
>

6 
usšg
 
Çme¥aû
 
	g¡d
;

8 şas 
	cSŞutiÚ
 {

9 
	mpublic
:

10 
veùÜ
<>

11 
ÿlcEqu©iÚ
(
veùÜ
 <veùÜ<
¡ršg
>> &
equ©iÚs
, veùÜ<> &
v®ues
, veùÜ <veùÜ<¡ršg>> &
qu”›s
) {

13 
	munÜd”ed_m­
 <
	m¡ršg
, unÜd”ed_m­<¡ršg, >> 
	mg¿ph
;

14 
	mi
 = 0; i < 
	mequ©iÚs
.
size
(); ++i) {

15 cÚ¡ 
	m¡ršg
 &
	ma
 = 
equ©iÚs
[
i
][0];

16 cÚ¡ 
	m¡ršg
 &
	mb
 = 
equ©iÚs
[
i
][1];

17 
	mv®ue
 = 
v®ues
[
i
];

18 
	mg¿ph
[
a
][
b
] = 
v®ue
;

19 
	mg¿ph
[
b
][
a
] = 1.0 / 
v®ue
;

23 
	mveùÜ
<> 
	m»suÉs
;

24 cÚ¡‡utØ&
	mqu”y
: 
qu”›s
) {

25 cÚ¡ 
¡ršg
 &
¡¬t
 = 
qu”y
[0];

26 cÚ¡ 
	m¡ršg
 &
	m’d
 = 
qu”y
[1];

27 
	munÜd”ed_£t
 <
	m¡ršg
> 
	mvis™ed
;

28 
	m»suÉ
 = 
dfs
(
g¿ph
, 
¡¬t
, 
’d
, 
vis™ed
);

29 
	m»suÉs
.
push_back
(
»suÉ
);

32  
	m»suÉs
;

35 
	g´iv©e
:

37 
dfs
(
unÜd”ed_m­
 <
¡ršg
, unÜd”ed_m­<¡ršg, >> &
g¿ph
, cÚ¡ sŒšg &
cu¼’t
, cÚ¡ sŒšg &
rg‘
,

38 
unÜd”ed_£t
 <
¡ršg
> &
vis™ed
) {

39 ià(
	gg¿ph
.
fšd
(
cu¼’t
è=ğ
g¿ph
.
’d
(è|| g¿ph.fšd(
rg‘
) == graph.end()) {

44 ià(
	gcu¼’t
 =ğ
rg‘
) {

49 
	gvis™ed
.
š£¹
(
cu¼’t
);

51 cÚ¡‡utØ&
	gÃighbÜ
: 
g¿ph
[
cu¼’t
]) {

52 cÚ¡ 
¡ršg
 &
Ãxt
 = 
ÃighbÜ
.
fœ¡
;

53 ià(
	gvis™ed
.
fšd
(
Ãxt
è=ğ
vis™ed
.
’d
()) {

54 
»suÉ
 = 
dfs
(
g¿ph
, 
Ãxt
, 
rg‘
, 
vis™ed
);

55 ià(
	g»suÉ
 != -1.0) {

57  
»suÉ
 * 
g¿ph
[
cu¼’t
][
Ãxt
];

66 
	$maš
() {

67 
SŞutiÚ
 
sŞutiÚ
;

69 
veùÜ
 <veùÜ<
¡ršg
>> 
equ©iÚs1
 = {{"a", "b"},

71 
veùÜ
<> 
v®ues1
 = {2.0, 3.0};

72 
veùÜ
 <veùÜ<
¡ršg
>> 
qu”›s1
 = {{"a", "c"},

77 
veùÜ
<> 
ouut1
 = 
sŞutiÚ
.
	`ÿlcEqu©iÚ
(
equ©iÚs1
, 
v®ues1
, 
qu”›s1
);

78 
»suÉ
: 
ouut1
) {

79 
cout
 << 
»suÉ
 << " ";

81 
cout
 << 
’dl
;

84 
	}
}

	@algorithm/graph/547.Number_of_Provinces/bfs.cpp

1 
	~<veùÜ
>

2 
	~<queue
>

4 şas 
	cSŞutiÚ
 {

5 
	mpublic
:

6 
fšdCœşeNum
(
¡d
::
veùÜ
 <¡d::veùÜ<>> &
isCÚÃùed
) {

7 
n
 = 
isCÚÃùed
.
size
();

8 
	m´ovšûs
 = 0;

9 
	m¡d
::
veùÜ
<
boŞ
> 
vis™ed
(
n
, 
çl£
);

11 
	mi
 = 0; i < 
	mn
; ++i) {

12 ià(!
	mvis™ed
[
i
]) {

13 
bfs
(
isCÚÃùed
, 
vis™ed
, 
i
);

14 ++
	m´ovšûs
;

18  
	m´ovšûs
;

21 
bfs
(
¡d
::
veùÜ
 <¡d::veùÜ<>> &
isCÚÃùed
, std::veùÜ<
boŞ
> &
vis™ed
, 
¡¬tC™y
) {

22 
	g¡d
::
queue
<> 
q
;

23 
	gq
.
push
(
¡¬tC™y
);

24 
	gvis™ed
[
¡¬tC™y
] = 
Œue
;

26 !
	gq
.
em±y
()) {

27 
	gc™y
 = 
q
.
äÚt
();

28 
	gq
.
pİ
();

30 
	gj
 = 0; j < 
	gisCÚÃùed
.
size
(); ++j) {

31 ià(
	gisCÚÃùed
[
c™y
][
j
] =ğ1 && !
vis™ed
[j]) {

32 
q
.
push
(
j
);

33 
	gvis™ed
[
j
] = 
Œue
;

	@algorithm/graph/547.Number_of_Provinces/dfs.cpp

1 şas 
	cSŞutiÚ
 {

2 
	mpublic
:

3 
fšdCœşeNum
(
¡d
::
veùÜ
 <¡d::veùÜ<>> &
isCÚÃùed
) {

4 
n
 = 
isCÚÃùed
.
size
();

5 
	m´ovšûs
 = 0;

6 
	m¡d
::
veùÜ
<
boŞ
> 
vis™ed
(
n
, 
çl£
);

8 
	mi
 = 0; i < 
	mn
; ++i) {

9 ià(!
	mvis™ed
[
i
]) {

10 
dfs
(
isCÚÃùed
, 
vis™ed
, 
i
);

11 ++
	m´ovšûs
;

15  
	m´ovšûs
;

18 
dfs
(
¡d
::
veùÜ
 <¡d::veùÜ<>> &
isCÚÃùed
, std::veùÜ<
boŞ
> &
vis™ed
, 
c™y
) {

19 
	gvis™ed
[
c™y
] = 
Œue
;

21 
	gj
 = 0; j < 
	gisCÚÃùed
.
size
(); ++j) {

22 ià(
	gisCÚÃùed
[
c™y
][
j
] =ğ1 && !
vis™ed
[j]) {

23 
dfs
(
isCÚÃùed
, 
vis™ed
, 
j
);

	@algorithm/graph/684.Redundant_Connection/dfs.cpp

2 şas 
	cSŞutiÚ
 {

3 
	mpublic
:

4 
veùÜ
<> 
fšdRedundªtCÚÃùiÚ
(veùÜ <veùÜ<>> &
edges
) {

5 
n
 = 
edges
.
size
();

6 
	mveùÜ
<> 
·»Á
(
n
 + 1, 0);

8 
	mi
 = 0; i <ğ
n
; ++i) {

9 
	m·»Á
[
i
] = i;

12 
	mveùÜ
<> 
	m»suÉ
;

14 cÚ¡‡utØ&
	medge
: 
edges
) {

15 
u
 = 
edge
[0];

16 
	mv
 = 
edge
[1];

18 
	mpu
 = 
fšd
(
·»Á
, 
u
);

19 
	mpv
 = 
fšd
(
·»Á
, 
v
);

21 ià(
	mpu
 =ğ
pv
) {

22 
»suÉ
 = 
edge
;

24 
	m·»Á
[
pv
] = 
pu
;

28  
	m»suÉ
;

31 
fšd
(
veùÜ
<> &
·»Á
, 
node
) {

32 
	g·»Á
[
node
] !=‚ode) {

33 
·»Á
[
node
] =…arent[parent[node]];

34 
	gnode
 = 
·»Á
[
node
];

36  
	gnode
;

	@algorithm/graph/684.Redundant_Connection/union_find.cpp

1 şas 
	cUniÚFšd
 {

2 
	mpublic
:

3 
	$UniÚFšd
(
n
è: 
	`·»Á
(n + 1) {

4 
i
 = 1; i <ğ
n
; ++i) {

5 
·»Á
[
i
] = i;

9 
	$fšd
(
x
) {

10 ià(
·»Á
[
x
] != x) {

11 
·»Á
[
x
] = 
	`fšd
(parent[x]);

13  
·»Á
[
x
];

14 
	}
}

16 
boŞ
 
	$un™e
(
x
, 
y
) {

17 
roÙX
 = 
	`fšd
(
x
);

18 
roÙY
 = 
	`fšd
(
y
);

19 ià(
roÙX
 =ğ
roÙY
) {

20  
çl£
;

22 
·»Á
[
roÙX
] = 
roÙY
;

23  
Œue
;

24 
	}
}

26 
	g´iv©e
:

27 
¡d
::
veùÜ
<> 
·»Á
;

30 şas 
	cSŞutiÚ
 {

31 
	mpublic
:

32 
¡d
::
veùÜ
<> 
fšdRedundªtCÚÃùiÚ
(¡d::veùÜ <¡d::veùÜ<>> &
edges
) {

33 
n
 = 
edges
.
size
();

34 
UniÚFšd
 
uf
(
n
);

36 
	m¡d
::
veùÜ
<> 
»suÉ
;

38 cÚ¡‡utØ&
	medge
: 
edges
) {

39 ià(!
uf
.
un™e
(
edge
[0],ƒdge[1])) {

41 
	m»suÉ
 = 
edge
;

45  
	m»suÉ
;

	@features/fs/cp/cp.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

4 
	#BUFFER_SIZE
 1024

	)

6 
	$maš
(
¬gc
, *
¬gv
[]) {

7 ià(
¬gc
 != 3) {

8 
	`´štf
("U§ge: % [sourû_fe] [rg‘_fe]\n", 
¬gv
[0]);

9  
EXIT_FAILURE
;

12 
FILE
 *
sourû_fe
, *
rg‘_fe
;

13 
bufãr
[
BUFFER_SIZE
];

14 
size_t
 
by‹s_»ad
;

16 
sourû_fe
 = 
	`fİ’
(
¬gv
[1], "rb");

17 ià(
sourû_fe
 =ğ
NULL
) {

18 
	`³¼Ü
("Error opening source file");

19  
EXIT_FAILURE
;

22 
rg‘_fe
 = 
	`fİ’
(
¬gv
[2], "wb");

23 ià(
rg‘_fe
 =ğ
NULL
) {

24 
	`³¼Ü
("Error openingarget file");

25 
	`fşo£
(
sourû_fe
);

26  
EXIT_FAILURE
;

29 (
by‹s_»ad
 = 
	`ä—d
(
bufãr
, 1, 
BUFFER_SIZE
, 
sourû_fe
)) > 0) {

30 
	`fwr™e
(
bufãr
, 1, 
by‹s_»ad
, 
rg‘_fe
);

33 
	`fşo£
(
sourû_fe
);

34 
	`fşo£
(
rg‘_fe
);

36 
	`´štf
("File copied successfully.\n");

38  
EXIT_SUCCESS
;

39 
	}
}

	@features/fs/ls/ls.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<dœ’t.h
>

5 
	$maš
() {

6 
DIR
 *
dœeùÜy
;

7 
dœ’t
 *
’Œy
;

9 
dœeùÜy
 = 
	`İ’dœ
(".");

10 ià(
dœeùÜy
 =ğ
NULL
) {

11 
	`³¼Ü
("Error opening directory");

12  
EXIT_FAILURE
;

15 (
’Œy
 = 
	`»addœ
(
dœeùÜy
)è!ğ
NULL
) {

16 
	`´štf
("%s\n", 
’Œy
->
d_Çme
);

19 
	`şo£dœ
(
dœeùÜy
);

21  
EXIT_SUCCESS
;

22 
	}
}

	@features/hashtable/hashtable.c

1 
	~"hashbË.h
"

6 
šlše
 
	$hash
(*
key
, 
b™s
)

9  ()(((è
key
 * 
GOLDEN_RATIO_32
è>> (32 - 
b™s
));

10 
	}
}

12 
šlše
 
hash_key
 *
	$fšd_key
 (
m­
 *
hash_m­
, *
key
)

15 
hli¡_h—d
 *
h—d
 = &(
hash_m­
->
ht
)[
	`hash
(
key
, hash_m­->
b™s
)];

16 
hli¡_node
 *
p
 = 
h—d
->
fœ¡
;…;… =…->
Ãxt
) {

17 
hash_key
 *
kn
 = 
	`cÚš”_of
(
p
, hash_key, 
node
);

18 ià(
kn
->
key
 == key)

19  
kn
;

21  
NULL
;

22 
	}
}

28 
	$m­_´št
(
m­
 *
hash_m­
, 
hash_ty³
 
ty³
)

31 ià(!
hash_m­
) {

32 
	`´štf
("Map is‚ot initialized.\n");

36 
i
 = 0; i < 
	`MAP_HASH_SIZE
(
hash_m­
->
b™s
); i++) {

37 
hli¡_h—d
 *
h—d
 = &
hash_m­
->
ht
[
i
];

39 
hli¡_node
 *
p
 = 
h—d
->
fœ¡
;

40 
p
) {

41 
hash_key
 *
kn
 = 
	`cÚš”_of
(
p
, hash_key, 
node
);

43 ià(
kn
->
key
) {

44 ià(
ty³
 =ğ
HASH_PRINT_INTEGER
) {

45 
	`´štf
("Key-V®u(št): %d - %d\n", (*)
kn
->
key
, (*)kn->
d©a
);

47 
	`´štf
("Key-V®u(¡ršg): % - %s\n", (*)
kn
->
key
, (*)kn->
d©a
);

51 
p
 =…->
Ãxt
;

54 
	}
}

56 
m­
 *
	$m­_š™
(
b™s
)

58 
m­
 *
hash_m­
 = 
	`m®loc
((map));

59 ià(!
hash_m­
)

60  
NULL
;

62 
hash_m­
->
b™s
 = bits;

63 
hash_m­
->
ht
 = 
	`m®loc
((
hli¡_h—d
è* 
	`MAP_HASH_SIZE
(hash_m­->
b™s
));

64 ià(
hash_m­
->
ht
) {

65 
i
 = 0; i < 
	`MAP_HASH_SIZE
(
hash_m­
->
b™s
); i++)

66 (
hash_m­
->
ht
)[
i
].
fœ¡
 = 
NULL
;

68 
	`ä“
(
hash_m­
);

69 
hash_m­
 = 
NULL
;

71  
hash_m­
;

72 
	}
}

74 
	$m­_add
(
m­
 *
hash_m­
, *
key
, *
d©a
)

76 
hash_key
 *
kn
 = 
	`fšd_key
(
hash_m­
, 
key
);

79 if(
kn
)

82 
kn
 = 
	`m®loc
((
hash_key
));

83 
kn
->
d©a
 = 
	`m®loc
(
HASH_DATA_SIZE
);

86 
kn
->
key
 = key;

87 
kn
->
d©a
 = data;

88 
hli¡_node
 *
n
 = &
kn
->
node
;

91 
hli¡_h—d
 *
h
 = &
hash_m­
->
ht
[
	`hash
(
key
, hash_m­->
b™s
)];

92 
hli¡_node
 *
fœ¡
 = 
h
->first;

94 
n
->
Ãxt
 = 
fœ¡
;

95 if(
fœ¡
)

96 
fœ¡
->
µ»v
 = &
n
->
Ãxt
;

98 
h
->
fœ¡
 = 
n
;

99 
n
->
µ»v
 = &
h
->
fœ¡
;

100 
	}
}

102 *
	$m­_g‘
(
m­
 *
hash_m­
, *
key
)

104 
hash_key
 *
kn
 = 
	`fšd_key
(
hash_m­
, 
key
);

105  
kn
 ? kn->
d©a
 : 
NULL
;

106 
	}
}

108 
	$m­_»move
(
m­
 *
hash_m­
, *
key
)

110 ià(!
hash_m­
 || !
key
) {

114 
hash_v®
 = 
	`hash
(
key
, 
hash_m­
->
b™s
);

115 
hli¡_h—d
 *
h—d
 = &
hash_m­
->
ht
[
hash_v®
];

117 
hli¡_node
 *
p
 = 
h—d
->
fœ¡
, **
µ»v
 = &head->first;

119 
p
) {

120 
hash_key
 *
kn
 = 
	`cÚš”_of
(
p
, hash_key, 
node
);

122 ià(
kn
->
key
 == key) {

123 *
µ»v
 = 
p
->
Ãxt
;

124 ià(
p
->
Ãxt
) {

125 
p
->
Ãxt
->
µ»v
 =…prev;

127 
p
->
Ãxt
 = 
NULL
;

128 
p
->
µ»v
 = 
NULL
;

130 
	`ä“
(
kn
->
d©a
);

131 
	`ä“
(
kn
);

135 
µ»v
 = &
p
->
Ãxt
;

136 
p
 =…->
Ãxt
;

138 
	}
}

140 
	$m­_deš™
(
m­
 *
hash_m­
)

142 ià(!
hash_m­
)

145 
i
 = 0; i < 
	`MAP_HASH_SIZE
(
hash_m­
->
b™s
); i++) {

146 
hli¡_h—d
 *
h—d
 = &
hash_m­
->
ht
[
i
];

147 
hli¡_node
 *
p
 = 
h—d
->
fœ¡
;…;) {

148 
hash_key
 *
kn
 = 
	`cÚš”_of
(
p
, hash_key, 
node
);

149 
hli¡_node
 *
n
 = 
p
;

150 
p
 =…->
Ãxt
;

152 ià(!
n
->
µ»v
)

153 
ba
;

155 
hli¡_node
 *
Ãxt
 = 
n
->Ãxt, **
µ»v
 =‚->pprev;

156 *
µ»v
 = 
Ãxt
;

157 ià(
Ãxt
)

158 
Ãxt
->
µ»v
 =…prev;

159 
n
->
Ãxt
 = 
NULL
,‚->
µ»v
 = NULL;

161 
ba
:

162 
	`ä“
(
kn
->
d©a
);

163 
	`ä“
(
kn
);

166 
	`ä“
(
hash_m­
);

167 
	}
}

	@features/hashtable/hashtable.h

1 #iâdeà
__HASHTABLE_H__


2 
	#__HASHTABLE_H__


	)

4 
	~<¡dio.h
>

5 
	~<¡dlib.h
>

6 
	~<¡ddef.h
>

7 
	~<¡ršg.h
>

8 
	~<lim™s.h
>

9 
	~<š‰y³s.h
>

25 
	shli¡_node


27 
hli¡_node
 *
	mÃxt
;

28 
hli¡_node
 **
	mµ»v
;

31 
	shli¡_h—d


33 
hli¡_node
 *
	mfœ¡
;

36 
	sm­


38 
	mb™s
;

39 
hli¡_h—d
 *
	mht
;

42 
	shash_key


44 *
	mkey
;

45 *
	md©a
;

46 
hli¡_node
 
	mnode
;

49 
	ehash_ty³


51 
	mHASH_PRINT_STRING
 = 0,

52 
	mHASH_PRINT_INTEGER
,

53 
	mHASH_PRINT_LAST


56 
	#cÚš”_of
(
±r
, 
ty³
, 
memb”
) \

58 *
__m±r
 = (*è(
±r
); \

59 ((
ty³
 *è(
__m±r
 - 
	`off£tof
Ñy³, 
memb”
))); \

60 })

	)

62 
	#GOLDEN_RATIO_32
 0x61C88647

	)

63 
	#MAP_HASH_SIZE
(
b™s
è(1 << (b™s))

	)

64 
	#HASH_DATA_SIZE
 1024

	)

65 
m­
 *
m­_š™
(
size
);

66 
m­_add
(
m­
 *
hash_m­
, *
key
, *
d©a
);

67 *
m­_g‘
(
m­
 *
hash_m­
, *
key
);

68 
m­_»move
(
m­
 *
hash_m­
,*
key
);

69 
m­_deš™
(
m­
 *
hash_m­
);

70 
m­_´št
(
m­
 *
hash_m­
, 
hash_ty³
 
ty³
);

	@features/hashtable/main.c

1 
	~"hashbË.h
"

2 
	~<¡dio.h
>

3 
	~<¡dlib.h
>

4 
	~<¡ršg.h
>

7 
	#EXPECT
(
ex´
, 
mes§ge
) \

9 ià(!(
ex´
)) { \

10 
	`´štf
("Te¡ faed: %s,e¡_couÁ = %d\n", 
mes§ge
, 
i
); \

11 
	`ex™
(1); \

13 } 0)

	)

15 
	$maš
() {

16 
m­
 *m­ = 
	`m­_š™
(20);

18 ià(!
m­
) {

19 
	`´štf
("Failedo initializehe map.\n");

24 
i
 = 1; i <= 1000000; i++) {

25 ià(
i
 % 2 == 0) {

27 
key_¡r
[20];

28 
	`¢´štf
(
key_¡r
, (key_¡r), "key%d", 
i
);

29 
v®ue_¡r
[20];

30 
	`¢´štf
(
v®ue_¡r
, (v®ue_¡r), "v®ue%d", 
i
);

31 
	`m­_add
(
m­
, (*)(
šŒ_t
)
i
, 
	`¡rdup
(
v®ue_¡r
));

34 
key_¡r
[20];

35 
	`¢´štf
(
key_¡r
, (key_¡r), "key%d", 
i
);

36 
	`m­_add
(
m­
, 
	`¡rdup
(
key_¡r
), (*)(
šŒ_t
)
i
);

41 
i
 = 1; i <= 1000000; i++) {

42 *
v®ue
;

43 ià(
i
 % 2 == 0) {

45 
v®ue
 = 
	`m­_g‘
(
m­
, (*)(
šŒ_t
)
i
);

46 
ex³ùed_v®ue_¡r
[20];

47 
	`¢´štf
(
ex³ùed_v®ue_¡r
, Óx³ùed_v®ue_¡r), "v®ue%d", 
i
);

48 
	`EXPECT
(
v®ue
 && 
	`¡rcmp
((*)v®ue, 
ex³ùed_v®ue_¡r
) == 0, "Value mismatch");

51 
key_¡r
[20];

52 
	`¢´štf
(
key_¡r
, (key_¡r), "key%d", 
i
);

53 
v®ue
 = 
	`m­_g‘
(
m­
, 
	`¡rdup
(
key_¡r
));

54 
	`EXPECT
(
v®ue
 && (
šŒ_t
)v®u=ğ
i
, "Value mismatch");

59 
	`m­_deš™
(
m­
);

61 
	`´štf
("Allests…assed!\n");

64 
	}
}

	@features/make_config/config.h

1 #iâdeà
CONFIG_H


2 
	#CONFIG_H


	)

4 
	#FLAG1
 1

	)

5 
	#FLAG2
 0

	)

6 
	#FLAG3
 1

	)

8 
	#FLAG_STR
 "RAVEN IS GOD !!!"

	)

10 
	#FLAG_SPACE


	)

	@features/make_config/main.c

1 
	~<¡dio.h
>

2 
	~"cÚfig.h
"

4 
	$maš
(){

6 #ifdeà
FLAG1_IS_DEFINED


7 
	`´štf
("flag 1 is set\n");

9 #ifdeà
FLAG2_IS_DEFINED


10 
	`´štf
("flag 2 is set\n");

12 #ifdeà
FLAG3_IS_DEFINED


13 
	`´štf
("flag 3 is set\n");

15 #ifdeà
FLAG_STR_IS_DEFINED


16 
	`´štf
("RAVEN is GOD\n");

18 #ifdeà
FLAG_SPACE_IS_DEFINED


19 
	`´štf
("space definition is…ass\n");

23 
	}
}

	@features/malloc/main.c

1 
	~<¡dio.h
>

3 
	#MAX_HEAPS
 4096

	)

5 
	tAlign
;

7 
	sh—d”
 {

8 
h—d”
 *
	m±r
;

9 
	msize
;

12 *
my_m®loc
(
nby‹s
);

13 
my_ä“
(*
­
);

15 
h—d”
 
	tH—d”
;

17 
	gh—ps
[
MAX_HEAPS
];

18 *
	g´og¿m_b»ak
 = 
h—ps
;

20 
H—d”
 
	gba£
;

21 
H—d”
 *
	gä“p
 = 
NULL
;

23 *
	$sbrk
(
nby‹s
)

25 
	`´štf
("break\n");

26 ià(
´og¿m_b»ak
 + 
nby‹s
 >ğ
h—ps


27 && 
´og¿m_b»ak
 + 
nby‹s
 < 
h—ps
 + 
MAX_HEAPS
) {

28 *
´evious_pb
 = 
´og¿m_b»ak
;

29 
´og¿m_b»ak
 +ğ
nby‹s
;

30  (*è
´evious_pb
;

33 
	}
}

35 *
	$my_m®loc
(
nby‹s
)

37 
H—d”
 *
p
, *
´evp
;

38 
nun™s
;

39 *
ı
;

44 
nun™s
 = (
nby‹s
 + (
H—d”
) - 1) / (Header) + 1;

47 ià((
´evp
 = 
ä“p
è=ğ
NULL
) {

48 
ba£
.
±r
 = 
ä“p
 = 
´evp
 = &base;

49 
ba£
.
size
 = 0;

53 
p
 = 
´evp
->
±r
; ;…revp =…,… =…->ptr) {

54 ià(
p
->
size
 >ğ
nun™s
) {

55 ià(
p
->
size
 =ğ
nun™s
) {

56 
´evp
->
±r
 = 
p
->ptr;

58 
p
->
size
 -ğ
nun™s
;

59 
p
 +ğp->
size
;

60 
p
->
size
 = 
nun™s
;

62 
ä“p
 = 
´evp
;

63  (*)(
p
 + 1);

66 ià(
p
 =ğ
ä“p
) {

69 
ı
 = 
	`sbrk
(
nun™s
 * (
H—d”
));

70 ià(
ı
 == (*) -1) {

71  
NULL
;

75 
p
 = (
H—d”
 *è
ı
;

76 
p
->
size
 = 
nun™s
;

77 
	`my_ä“
((*è(
p
 + 1));

78 
p
 = 
ä“p
;

82 
	}
}

84 
	$my_ä“
(*
­
)

86 
H—d”
 *
bp
, *
p
;

87 
bp
 = (
H—d”
 *è
­
 - 1;

89 
p
 = 
ä“p
; !(
bp
 >… && b°<…->
±r
);… =…->ptr) {

90 ià(
p
 >ğp->
±r
 && (
bp
 >… || bp <…->ptr))

95 ià(
bp
 + bp->
size
 =ğ
p
->
±r
) {

96 
bp
->
size
 +ğ
p
->
±r
->size;

97 
bp
->
±r
 = 
p
->ptr->ptr;

99 
bp
->
±r
 = 
p
->ptr;

103 ià(
p
 +…->
size
 =ğ
bp
) {

104 
p
->
size
 +ğ
bp
->size;

105 
p
->
±r
 = 
bp
->ptr;

107 
p
->
±r
 = 
bp
;

111 
ä“p
 = 
p
;

112 
	}
}

114 
	$maš
() {

115 
	`´štf
("Mallocest start\n");

116 *
£gm’t1
 = 
	`my_m®loc
(() * 10);

117 
	`´štf
("£gm’ˆ1 = %p\n", 
£gm’t1
);

118 *
£gm’t2
 = 
	`my_m®loc
(() * 10);

119 
	`´štf
("£gm’ˆ2 = %p\n", 
£gm’t2
);

120 *
£gm’t3
 = 
	`my_m®loc
(() * 10);

121 
	`´štf
("£gm’ˆ3 = %p\n", 
£gm’t3
);

122 
	`my_ä“
(
£gm’t2
);

123 
	`my_ä“
(
£gm’t1
);

124 
	`my_ä“
(
£gm’t3
);

125 *
£gm’t4
 = 
	`my_m®loc
(() * 20);

126 
	`´štf
("£gm’ˆ4 = %p\n", 
£gm’t4
);

127 *
£gm’t5
 = 
	`my_m®loc
(() * 10);

128 
	`´štf
("£gm’ˆ5 = %p\n", 
£gm’t5
);

129 *
£gm’t6
 = 
	`my_m®loc
(() * 20);

130 
	`´štf
("£gm’ˆ6 = %p\n", 
£gm’t6
);

131 
	`my_ä“
(
£gm’t4
);

132 
	`my_ä“
(
£gm’t5
);

133 *
£gm’t7
 = 
	`my_m®loc
(() * 20);

134 
	`´štf
("£gm’ˆ7 = %p\n", 
£gm’t7
);

135 
	`my_ä“
(
£gm’t6
);

136 
	`my_ä“
(
£gm’t7
);

137 
	`´štf
("Mallocest complete\n");

138 
	`´štf
("-----------------------------------------------------------\n");

139 
	`´štf
("ba£.±¸ğ%p, ba£.sizğ%d\n", 
ba£
.
±r
, ba£.
size
);

140 
	`´štf
("ä“p->±¸ğ%p, f»•->sizğ%d\n", 
ä“p
->
±r
, f»•->
size
);

141 
	`´štf
("´og¿m_b»ak = %p\n", 
´og¿m_b»ak
);

142 
	`´štf
("sizeof(¡ruù h—d”èğ%lu\n", (
h—d”
));

144 
	}
}

	@features/queue/list.h

1 #iâdeà
__LIST_H__


2 
	#__LIST_H__


	)

4 
	tsize_t
;

36 
	sli¡_h—d
 {

37 
li¡_h—d
 *
	mÃxt
, *
	m´ev
;

50 
	#off£tof
(
TYPE
, 
MEMBER
è((
size_t
è&((TYPE *)0)->MEMBER)

	)

52 
	#cÚš”_of
(
±r
, 
ty³
, 
memb”
) \

54 cÚ¡ 
	`__ty³of__
(((
ty³
 *è0)->
memb”
è*
__pmemb”
 = (
±r
); \

55 (
ty³
 *è((*è
__pmemb”
 - 
	`off£tof
Ñy³, 
memb”
)); \

56 })

	)

63 
	#LIST_HEAD
(
h—d
è
li¡_h—d
 h—d = {&(h—d), &(h—d)}

	)

80 
šlše
 
	$INIT_LIST_HEAD
(
li¡_h—d
 *
h—d
)

82 
h—d
->
Ãxt
 = head;

83 
h—d
->
´ev
 = head;

84 
	}
}

91 
šlše
 
	$li¡_add
(
li¡_h—d
 *
node
, li¡_h—d *
h—d
)

93 
li¡_h—d
 *
Ãxt
 = 
h—d
->next;

95 
Ãxt
->
´ev
 = 
node
;

96 
node
->
Ãxt
 =‚ext;

97 
node
->
´ev
 = 
h—d
;

98 
h—d
->
Ãxt
 = 
node
;

99 
	}
}

117 
šlše
 
	$li¡_d–
(
li¡_h—d
 *
node
)

119 
li¡_h—d
 *
Ãxt
 = 
node
->next;

120 
li¡_h—d
 *
´ev
 = 
node
->prev;

122 
Ãxt
->
´ev
 =…rev;

123 
´ev
->
Ãxt
 =‚ext;

124 
	}
}

132 
šlše
 
	$li¡_em±y
(cÚ¡ 
li¡_h—d
 *
h—d
)

134  (
h—d
->
Ãxt
 == head);

135 
	}
}

145 
	#li¡_’Œy
(
node
, 
ty³
, 
memb”
è
	`cÚš”_of
Òode,y³, memb”)

	)

155 
	#li¡_fœ¡_’Œy
(
h—d
, 
ty³
, 
memb”
) \

156 
	`li¡_’Œy
((
h—d
)->
Ãxt
, 
ty³
, 
memb”
)

	)

166 
	#li¡_Ï¡_’Œy
(
h—d
, 
ty³
, 
memb”
) \

167 
	`li¡_’Œy
((
h—d
)->
´ev
, 
ty³
, 
memb”
)

	)

	@features/queue/queue.c

1 
	~"li¡.h
"

2 
	~<¡dio.h
>

5 
	mQUEUE_NORMAL
;

6 
	mQUEUE_HEAD
;

10 
li¡_h—d
 
	mnode
;

11 
	mv®
;

12 
	mæag
;

13 
	mcouÁ
;

14 } 
	tMyQueue
;

17 
MyQueue
* 
	$myQueueC»©e
() {

18 
MyQueue
 *
h—d
 = 
	`m®loc
((MyQueue));

19 
h—d
->
v®
 = -1;

20 
h—d
->
æag
 = 
QUEUE_HEAD
;

21 
	`INIT_LIST_HEAD
(&
h—d
->
node
);

22 
h—d
->
couÁ
 = 0;

23  
h—d
;

24 
	}
}

26 
	$myQueuePush
(
MyQueue
* 
obj
, 
x
) {

28 
	}
}

30 
	$myQueuePİ
(
MyQueue
* 
obj
) {

32 
	}
}

34 
	$myQueueP“k
(
MyQueue
* 
obj
) {

36 
	}
}

38 
boŞ
 
	$myQueueEm±y
(
MyQueue
* 
obj
) {

39  
	`li¡_em±y
(&
obj
->
node
);

40 
	}
}

42 
	$myQueueF»e
(
MyQueue
* 
obj
) {

44 
	}
}

46 
	$maš
() {

49 
	}
}

	@performance/neon/matrix/main.c

1 
	~<¡dio.h
>

2 
	~<¡dšt.h
>

3 
	~<¡dlib.h
>

4 
	~<¡dboŞ.h
>

5 
	~<m©h.h
>

6 
	~<time.h
>

8 
	~<¬m_ÃÚ.h
>

10 
	#LOOP
 10000

	)

12 
	$m©rix_muÉly_c
(
æßt32_t
 *
A
, flßt32_ˆ*
B
, flßt32_ˆ*
C
)

14 
i_idx
 = 0; i_idx < 4; i_idx++)

16 
j_idx
 = 0; j_idx < 4; j_idx++)

18 
C
[4 * 
j_idx
 + 
i_idx
] = 0;

19 
k_idx
 = 0; k_idx < 4; k_idx++)

21 
C
[4 * 
j_idx
 + 
i_idx
] +ğ
A
[4 * 
k_idx
 + i_idx] * 
B
[4 * j_idx + k_idx];

25 
	}
}

27 
	$m©rix_muÉly_4x4_ÃÚ
(
æßt32_t
 *
A
, flßt32_ˆ*
B
, flßt32_ˆ*
C
)

29 
æßt32x4_t
 
A0
;

30 
æßt32x4_t
 
A1
;

31 
æßt32x4_t
 
A2
;

32 
æßt32x4_t
 
A3
;

34 
æßt32x4_t
 
B0
;

35 
æßt32x4_t
 
B1
;

36 
æßt32x4_t
 
B2
;

37 
æßt32x4_t
 
B3
;

39 
æßt32x4_t
 
C0
;

40 
æßt32x4_t
 
C1
;

41 
æßt32x4_t
 
C2
;

42 
æßt32x4_t
 
C3
;

44 
A0
 = 
	`vld1q_f32
(
A
);

45 
A1
 = 
	`vld1q_f32
(
A
 + 4);

46 
A2
 = 
	`vld1q_f32
(
A
 + 8);

47 
A3
 = 
	`vld1q_f32
(
A
 + 12);

49 
C0
 = 
	`vmovq_n_f32
(0);

50 
C1
 = 
	`vmovq_n_f32
(0);

51 
C2
 = 
	`vmovq_n_f32
(0);

52 
C3
 = 
	`vmovq_n_f32
(0);

54 
B0
 = 
	`vld1q_f32
(
B
);

55 
C0
 = 
	`vfmaq_ÏÃq_f32
(C0, 
A0
, 
B0
, 0);

56 
C0
 = 
	`vfmaq_ÏÃq_f32
(C0, 
A1
, 
B0
, 1);

57 
C0
 = 
	`vfmaq_ÏÃq_f32
(C0, 
A2
, 
B0
, 2);

58 
C0
 = 
	`vfmaq_ÏÃq_f32
(C0, 
A3
, 
B0
, 3);

59 
	`v¡1q_f32
(
C
, 
C0
);

61 
B1
 = 
	`vld1q_f32
(
B
 + 4);

62 
C1
 = 
	`vfmaq_ÏÃq_f32
(C1, 
A0
, 
B1
, 0);

63 
C1
 = 
	`vfmaq_ÏÃq_f32
(C1, 
A1
, 
B1
, 1);

64 
C1
 = 
	`vfmaq_ÏÃq_f32
(C1, 
A2
, 
B1
, 2);

65 
C1
 = 
	`vfmaq_ÏÃq_f32
(C1, 
A3
, 
B1
, 3);

66 
	`v¡1q_f32
(
C
 + 4, 
C1
);

68 
B2
 = 
	`vld1q_f32
(
B
 + 8);

69 
C2
 = 
	`vfmaq_ÏÃq_f32
(C2, 
A0
, 
B2
, 0);

70 
C2
 = 
	`vfmaq_ÏÃq_f32
(C2, 
A1
, 
B2
, 1);

71 
C2
 = 
	`vfmaq_ÏÃq_f32
(C2, 
A2
, 
B2
, 2);

72 
C2
 = 
	`vfmaq_ÏÃq_f32
(C2, 
A3
, 
B2
, 3);

73 
	`v¡1q_f32
(
C
 + 8, 
C2
);

75 
B3
 = 
	`vld1q_f32
(
B
 + 12);

76 
C3
 = 
	`vfmaq_ÏÃq_f32
(C3, 
A0
, 
B3
, 0);

77 
C3
 = 
	`vfmaq_ÏÃq_f32
(C3, 
A1
, 
B3
, 1);

78 
C3
 = 
	`vfmaq_ÏÃq_f32
(C3, 
A2
, 
B3
, 2);

79 
C3
 = 
	`vfmaq_ÏÃq_f32
(C3, 
A3
, 
B3
, 3);

80 
	`v¡1q_f32
(
C
 + 12, 
C3
);

81 
	}
}

83 
	$m©rix_muÉly_4x4_asm
(
æßt32_t
 *
A
, flßt32_ˆ*
B
, flßt32_ˆ*
C
)

85 
asm
 volatile(

116 : [
a
] "r"(
A
), [
b
] "r"(
B
), [
c
] "r"(
C
)

120 
	}
}

122 
	$´št_m©rix
(
æßt32_t
 *
M
, 
ušt32_t
 
cŞs
, ušt32_ˆ
rows
)

124 
i
 = 0; i < 
rows
; i++)

126 
j
 = 0; j < 
cŞs
; j++)

128 
	`´štf
("%à", 
M
[
j
 * 
rows
 + 
i
]);

130 
	`´štf
("\n");

132 
	`´štf
("\n");

133 
	}
}

135 
	$m©rix_š™_¿nd
(
æßt32_t
 *
M
, 
ušt32_t
 
numv®s
)

137 
i
 = 0; i < 
numv®s
; i++)

139 
M
[
i
] = ()
	`¿nd
(è/ ()(
RAND_MAX
);

141 
	}
}

143 
	$m©rix_š™
(
æßt32_t
 *
M
, 
ušt32_t
 
cŞs
, ušt32_ˆ
rows
, flßt32_ˆ
v®
)

145 
i
 = 0; i < 
rows
; i++)

147 
j
 = 0; j < 
cŞs
; j++)

149 
M
[
j
 * 
rows
 + 
i
] = 
v®
;

152 
	}
}

154 
boŞ
 
	$f32comp_nÙeq
(
æßt32_t
 
a
, flßt32_ˆ
b
)

156 ià(
	`çbs
(
a
 - 
b
) < 0.000001)

158  
çl£
;

160  
Œue
;

161 
	}
}

163 
boŞ
 
	$m©rix_comp
(
æßt32_t
 *
A
, flßt32_ˆ*
B
, 
ušt32_t
 
rows
, ušt32_ˆ
cŞs
)

165 
æßt32_t
 
a
;

166 
æßt32_t
 
b
;

167 
i
 = 0; i < 
rows
; i++)

169 
j
 = 0; j < 
cŞs
; j++)

171 
a
 = 
A
[
rows
 * 
j
 + 
i
];

172 
b
 = 
B
[
rows
 * 
j
 + 
i
];

174 ià(
	`f32comp_nÙeq
(
a
, 
b
))

176 
	`´štf
("i=%d, j=%d, A=%f, B=%f\n", 
i
, 
j
, 
a
, 
b
);

177  
çl£
;

181  
Œue
;

182 
	}
}

184 
	$maš
()

186 
i
;

187 
time¥ec
 
time_¡¬t
, 
time_’d
;

188 
şocks_c
, 
şocks_ÃÚ
, 
şocks_asm
;

190 
æßt32_t
 
A
[16];

191 
æßt32_t
 
B
[16];

192 
æßt32_t
 
C
[16];

193 
æßt32_t
 
D
[16];

194 
æßt32_t
 
E
[16];

196 
boŞ
 
c_eq_asm
;

197 
boŞ
 
c_eq_ÃÚ
;

199 
	`m©rix_š™_¿nd
(
A
, 16);

200 
	`m©rix_š™_¿nd
(
B
, 16);

201 
	`m©rix_š™
(
C
, 4, 4, 0);

203 
	`´štf
("Matrix A:\n");

204 
	`´št_m©rix
(
A
, 4, 4);

205 
	`´štf
("Matrix B:\n");

206 
	`´št_m©rix
(
B
, 4, 4);

208 
	`şock_g‘time
(
CLOCK_REALTIME
, &
time_¡¬t
);

209 
i
 = 0; i < 
LOOP
; i++)

210 
	`m©rix_muÉly_c
(
A
, 
B
, 
C
);

211 
	`şock_g‘time
(
CLOCK_REALTIME
, &
time_’d
);

212 
şocks_c
 = (
time_’d
.
tv_£c
 - 
time_¡¬t
.tv_sec) * 1000000 +

213 (
time_’d
.
tv_n£c
 - 
time_¡¬t
.tv_nsec) / 1000;

214 
	`´štf
("ø¥’ˆtim:%ld us\n", 
şocks_c
);

215 
	`´št_m©rix
(
C
, 4, 4);

217 
	`şock_g‘time
(
CLOCK_REALTIME
, &
time_¡¬t
);

218 
i
 = 0; i < 
LOOP
; i++)

219 
	`m©rix_muÉly_4x4_ÃÚ
(
A
, 
B
, 
D
);

220 
	`şock_g‘time
(
CLOCK_REALTIME
, &
time_’d
);

221 
şocks_ÃÚ
 = (
time_’d
.
tv_£c
 - 
time_¡¬t
.tv_sec) * 1000000 +

222 (
time_’d
.
tv_n£c
 - 
time_¡¬t
.tv_nsec) / 1000;

223 
	`´štf
("NeÚ IÁršsic ¥’ˆtim:%ld us\n", 
şocks_ÃÚ
);

224 
	`´št_m©rix
(
D
, 4, 4);

226 
	`şock_g‘time
(
CLOCK_REALTIME
, &
time_¡¬t
);

227 
i
 = 0; i < 
LOOP
; i++)

228 
	`m©rix_muÉly_4x4_asm
(
A
, 
B
, 
E
);

229 
	`şock_g‘time
(
CLOCK_REALTIME
, &
time_’d
);

230 
şocks_asm
 = (
time_’d
.
tv_£c
 - 
time_¡¬t
.tv_sec) * 1000000 +

231 (
time_’d
.
tv_n£c
 - 
time_¡¬t
.tv_nsec) / 1000;

232 
	`´štf
("asm s³Áim:%ld us\n", 
şocks_asm
);

233 
	`´št_m©rix
(
E
, 4, 4);

235 
c_eq_ÃÚ
 = 
	`m©rix_comp
(
C
, 
D
, 4, 4);

236 
	`´štf
("NeÚƒqu®ØC: %s\n", 
c_eq_ÃÚ
 ? "yes" : "no");

237 
c_eq_ÃÚ
 = 
	`m©rix_comp
(
C
, 
E
, 4, 4);

238 
	`´štf
("Asmƒqu®ØC: %s\n", 
c_eq_ÃÚ
 ? "yes" : "no");

239 
	`´štf
("===============================\n");

241 
	`´štf
("asm fa¡”hª c: %f\n", ()
şocks_c
 / 
şocks_asm
);

242 
	`´štf
("asm fa¡”hª‚eÚ IÁršsics: %f\n", ()
şocks_ÃÚ
 / 
şocks_asm
);

243 
	}
}

	@performance/neon/memcpy/benchmark.c

1 
	~<¬m_ÃÚ.h
>

2 
	~<¡ddef.h
>

3 
	~<¡dlib.h
>

4 
	~<¡ršg.h
>

5 
	~<¡dio.h
>

6 
	~<time.h
>

9 *
	$ÃÚ_memıy
(*
de¡
, cÚ¡ *
¤c
, 
size_t
 
n
) {

10 
ušt8_t
 *
d
 = (ušt8_ˆ*)
de¡
;

11 cÚ¡ 
ušt8_t
 *
s
 = (cÚ¡ ušt8_ˆ*)
¤c
;

14 
n
 >= 16) {

15 
	`v¡1q_u8
(
d
, 
	`vld1q_u8
(
s
));

16 
s
 += 16;

17 
d
 += 16;

18 
n
 -= 16;

22 
n
 > 0) {

23 *
d
++ = *
s
++;

24 
n
--;

27  
de¡
;

28 
	}
}

31 *
	$ÃÚ_mem£t
(*
s
, 
c
, 
size_t
 
n
) {

32 
ušt8_t
 *
d¡
 = (ušt8_ˆ*)
s
;

33 
ušt8x16_t
 
v®ue
 = 
	`vdupq_n_u8
((
ušt8_t
)
c
);

36 
n
 >= 16) {

37 
	`v¡1q_u8
(
d¡
, 
v®ue
);

38 
d¡
 += 16;

39 
n
 -= 16;

43 
n
 > 0) {

44 *
d¡
++ = (
ušt8_t
)
c
;

45 
n
--;

48  
s
;

49 
	}
}

52 
b’chm¬k
(*(*
memıy_func
)(*, cÚ¡ *, 
size_t
), *(*
mem£t_func
)(*, , size_t)) {

53 cÚ¡ 
	gsize
 = 1024ULL * 1024ULL * 1024ULL * 1024ULL;

54 
ušt8_t
 *
	g¤c
 = 
m®loc
(
size
);

55 
ušt8_t
 *
	gd¡
 = 
m®loc
(
size
);

58 
mem£t
(
¤c
, 0xAA, 
size
);

61 
şock_t
 
	g¡¬t
 = 
şock
();

62 
memıy_func
(
d¡
, 
¤c
, 
size
);

63 
şock_t
 
	g’d
 = 
şock
();

64 
´štf
("memıyook %à£cÚds\n", ()(
’d
 - 
¡¬t
è/ 
CLOCKS_PER_SEC
);

67 
	g¡¬t
 = 
şock
();

68 
mem£t_func
(
d¡
, 0x55, 
size
);

69 
	g’d
 = 
şock
();

70 
´štf
("mem£ˆtook %à£cÚds\n", ()(
’d
 - 
¡¬t
è/ 
CLOCKS_PER_SEC
);

72 
ä“
(
¤c
);

73 
ä“
(
d¡
);

76 
	$maš
() {

77 
	`´štf
("Benchmarking standard functions...\n");

78 
	`b’chm¬k
(
memıy
, 
mem£t
);

80 
	`´štf
("\nBenchmarking NEON functions...\n");

81 
	`b’chm¬k
(
ÃÚ_memıy
, 
ÃÚ_mem£t
);

84 
	}
}

	@performance/neon/rgb/main.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<¡dšt.h
>

4 
	~<¡dboŞ.h
>

5 
	~<¡ršg.h
>

6 
	~<¬m_ÃÚ.h
>

7 
	~<time.h
>

9 
	$rgb24_bgr24_c
(*
¤c
, *
d¡
, 
couÁ
)

11 
i
;

13 
i
 = 0; i < 
couÁ
; i++)

15 
d¡
[3 * 
i
] = 
¤c
[3 * i + 2];

16 
d¡
[3 * 
i
 + 1] = 
¤c
[3 * i + 1];

17 
d¡
[3 * 
i
 + 2] = 
¤c
[3 * i];

19 
	}
}

21 
	$rgb24_bgr24_asm
(*
¤c
, *
d¡
, 
couÁ
)

23 
couÁ
 = count * 3;

24 
size
 = 0;

26 
asm
 volatile(

35 : [
d¡
] "+r"(d¡), [
¤c
] "+r"(¤c), [
size
] "+r"(size)

36 : [
couÁ
] "r"(count)

38 
	}
}

40 
	$rgb24_bgr24_ÃÚ_šŒ
(*
¤c
, *
d¡
, 
couÁ
)

42 
i
;

44 
couÁ
 = count * 3;

46 
ušt8x16x3_t
 
rgb
;

47 
ušt8x16x3_t
 
bgr
;

49 
ušt8x16_t
 
vz”o
 = 
	`vmovq_n_u8
(0);

51 
i
 = 0; i < 
couÁ
 / 48; i++)

53 
rgb
 = 
	`vld3q_u8
(
¤c
 + 3 * 16 * 
i
);

55 
bgr
.
v®
[2] = 
	`vÜrq_u8
(
rgb
.v®[0], 
vz”o
);

56 
bgr
.
v®
[0] = 
	`vÜrq_u8
(
rgb
.v®[2], 
vz”o
);

57 
bgr
.
v®
[1] = 
	`vÜrq_u8
(
rgb
.v®[1], 
vz”o
);

59 
	`v¡3q_u8
(
d¡
 + 3 * 16 * 
i
, 
bgr
);

61 
	}
}

63 
	#IMAGE_SIZE
 (4096 * 2160 * 10)

	)

64 
	#PIXEL_SIZE
 (
IMAGE_SIZE
 * 3)

	)

66 
	$maš
(
¬gc
, *
¬gv
[])

68 
i
;

69 
time¥ec
 
time_¡¬t
, 
time_’d
;

70 
time_c
, 
time_ÃÚ
, 
time_asm
;

72 *
rgb24_¤c
 = 
	`m®loc
(
PIXEL_SIZE
);

73 ià(!
rgb24_¤c
)

75 
	`mem£t
(
rgb24_¤c
, 0, 
PIXEL_SIZE
);

77 *
bgr24_c
 = 
	`m®loc
(
PIXEL_SIZE
);

78 ià(!
bgr24_c
)

80 
	`mem£t
(
bgr24_c
, 0, 
PIXEL_SIZE
);

82 *
bgr24_asm
 = 
	`m®loc
(
PIXEL_SIZE
);

83 ià(!
bgr24_asm
)

85 
	`mem£t
(
bgr24_asm
, 0, 
PIXEL_SIZE
);

87 *
bgr24_ÃÚ
 = 
	`m®loc
(
PIXEL_SIZE
);

88 ià(!
bgr24_ÃÚ
)

90 
	`mem£t
(
bgr24_ÃÚ
, 0, 
PIXEL_SIZE
);

92 
i
 = 0; i < 
PIXEL_SIZE
; i++)

94 
rgb24_¤c
[
i
] = 
	`¿nd
() & 0xff;

97 
	`şock_g‘time
(
CLOCK_REALTIME
, &
time_¡¬t
);

98 
	`rgb24_bgr24_c
(
rgb24_¤c
, 
bgr24_c
, 
IMAGE_SIZE
);

99 
	`şock_g‘time
(
CLOCK_REALTIME
, &
time_’d
);

100 
time_c
 = (
time_’d
.
tv_£c
 - 
time_¡¬t
.tv_sec) * 1000 +

101 (
time_’d
.
tv_n£c
 - 
time_¡¬t
.tv_nsec) / 1000000;

102 
	`´štf
("ø¥’dim:%ld ms\n", 
time_c
);

104 
	`şock_g‘time
(
CLOCK_REALTIME
, &
time_¡¬t
);

105 
	`rgb24_bgr24_ÃÚ_šŒ
(
rgb24_¤c
, 
bgr24_ÃÚ
, 
IMAGE_SIZE
);

106 
	`şock_g‘time
(
CLOCK_REALTIME
, &
time_’d
);

107 
time_ÃÚ
 = (
time_’d
.
tv_£c
 - 
time_¡¬t
.tv_sec) * 1000 +

108 (
time_’d
.
tv_n£c
 - 
time_¡¬t
.tv_nsec) / 1000000;

109 
	`´štf
("ÃÚ iÁ¸¥’dim:%ld ms\n", 
time_ÃÚ
);

111 
	`şock_g‘time
(
CLOCK_REALTIME
, &
time_¡¬t
);

112 
	`rgb24_bgr24_asm
(
rgb24_¤c
, 
bgr24_asm
, 
IMAGE_SIZE
);

113 
	`şock_g‘time
(
CLOCK_REALTIME
, &
time_’d
);

114 
time_asm
 = (
time_’d
.
tv_£c
 - 
time_¡¬t
.tv_sec) * 1000 +

115 (
time_’d
.
tv_n£c
 - 
time_¡¬t
.tv_nsec) / 1000000;

116 
	`´štf
("asm s³ndim:%ld ms\n", 
time_asm
);

118 ià(
	`memcmp
(
bgr24_c
, 
bgr24_asm
, 
PIXEL_SIZE
è|| memcmp(bgr24_c, 
bgr24_ÃÚ
, PIXEL_SIZE))

119 
	`´štf
("error on bgr data\n");

121 
	`´štf
("bg¸»suÉ (%dèi id’tŸl\n", 
PIXEL_SIZE
);

123 
	`´štf
("asm fa¡hª c: %f\n", ()
time_c
 / 
time_asm
);

124 
	`´štf
("asm fa¡hª‚eÚ_šŒ: %f\n", ()
time_ÃÚ
 / 
time_asm
);

126 
	`ä“
(
rgb24_¤c
);

127 
	`ä“
(
bgr24_c
);

128 
	`ä“
(
bgr24_asm
);

129 
	`ä“
(
bgr24_ÃÚ
);

132 
	}
}

	@performance/qsort/hsort.c

12 
	~<¡dio.h
>

13 
	~<¡dlib.h
>

14 
	~<¡dboŞ.h
>

15 
	~<¡dšt.h
>

16 
	~<sys/time.h
>

18 (*
	tsw­_func_t
)(*
	ta
, *
	tb
, 
	tsize
);

20 (*
	tcmp_r_func_t
)(cÚ¡ *
	ta
, cÚ¡ *
	tb
, cÚ¡ *
	t´iv
);

21 (*
	tcmp_func_t
)(cÚ¡ *
	ta
, cÚ¡ *
	tb
);

36 
boŞ
 
	$is_®igÃd
(cÚ¡ *
ba£
, 
size_t
 
size
, 
®ign
)

38 
lsb™s
 = ()
size
;

40 ()
ba£
;

41 #iâdeà
CONFIG_HAVE_EFFICIENT_UNALIGNED_ACCESS


42 
lsb™s
 |ğ()(
ušŒ_t
)
ba£
;

44  (
lsb™s
 & (
®ign
 - 1)) == 0;

45 
	}
}

61 
	$sw­_wÜds_32
(*
a
, *
b
, 
size_t
 
n
)

64 
ušt32_t
 
t
 = *(ušt32_ˆ*)(
a
 + (
n
 -= 4));

65 *(
ušt32_t
 *)(
a
 + 
n
èğ*(ušt32_ˆ*)(
b
 +‚);

66 *(
ušt32_t
 *)(
b
 + 
n
èğ
t
;

67 } 
n
);

68 
	}
}

86 
	$sw­_wÜds_64
(*
a
, *
b
, 
size_t
 
n
)

89 #ifdeà
CONFIG_64BIT


90 
	`´štf
("64 bit\n");

91 
ušt64_t
 
t
 = *(ušt64_ˆ*)(
a
 + (
n
 -= 8));

92 *(
ušt64_t
 *)(
a
 + 
n
èğ*(ušt64_ˆ*)(
b
 +‚);

93 *(
ušt64_t
 *)(
b
 + 
n
èğ
t
;

95 
	`´štf
("32 bit\n");

97 
ušt32_t
 
t
 = *(ušt32_ˆ*)(
a
 + (
n
 -= 4));

98 *(
ušt32_t
 *)(
a
 + 
n
èğ*(ušt32_ˆ*)(
b
 +‚);

99 *(
ušt32_t
 *)(
b
 + 
n
èğ
t
;

101 
t
 = *(
ušt32_t
 *)(
a
 + (
n
 -= 4));

102 *(
ušt32_t
 *)(
a
 + 
n
èğ*(ušt32_ˆ*)(
b
 +‚);

103 *(
ušt32_t
 *)(
b
 + 
n
èğ
t
;

105 } 
n
);

106 
	}
}

116 
	$sw­_by‹s
(*
a
, *
b
, 
size_t
 
n
)

119 
t
 = ((*)
a
)[--
n
];

120 ((*)
a
)[
n
] = ((*)
b
)[n];

121 ((*)
b
)[
n
] = 
t
;

122 } 
n
);

123 
	}
}

130 
	#SWAP_WORDS_64
 (
sw­_func_t
)0

	)

131 
	#SWAP_WORDS_32
 (
sw­_func_t
)1

	)

132 
	#SWAP_BYTES
 (
sw­_func_t
)2

	)

138 
	$do_sw­
(*
a
, *
b
, 
size_t
 
size
, 
sw­_func_t
 
sw­_func
)

140 ià(
sw­_func
 =ğ
SWAP_WORDS_64
)

141 
	`sw­_wÜds_64
(
a
, 
b
, 
size
);

142 ià(
sw­_func
 =ğ
SWAP_WORDS_32
)

143 
	`sw­_wÜds_32
(
a
, 
b
, 
size
);

144 ià(
sw­_func
 =ğ
SWAP_BYTES
)

145 
	`sw­_by‹s
(
a
, 
b
, 
size
);

147 
	`sw­_func
(
a
, 
b
, ()
size
);

148 
	}
}

150 
	#_CMP_WRAPPER
 ((
cmp_r_func_t
)0L)

	)

152 
	$do_cmp
(cÚ¡ *
a
, cÚ¡ *
b
, 
cmp_r_func_t
 
cmp
, cÚ¡ *
´iv
)

154 ià(
cmp
 =ğ
_CMP_WRAPPER
)

155  ((
cmp_func_t
)(
´iv
))(
a
, 
b
);

156  
	`cmp
(
a
, 
b
, 
´iv
);

157 
	}
}

177 
size_t
 
	$·»Á
(
size_t
 
i
, 
lsb™
, size_ˆ
size
)

179 
i
 -ğ
size
;

180 
i
 -ğ
size
 & -(˜& 
lsb™
);

181  
i
 / 2;

182 
	}
}

203 
	$sÜt_r
(*
ba£
, 
size_t
 
num
, size_ˆ
size
,

204 
cmp_r_func_t
 
cmp_func
,

205 
sw­_func_t
 
sw­_func
,

206 cÚ¡ *
´iv
)

209 
size_t
 
n
 = 
num
 * 
size
, 
a
 = (num/2) * size;

210 cÚ¡ 
lsb™
 = 
size
 & -size;

212 ià(!
a
)

215 ià(!
sw­_func
) {

216 ià(
	`is_®igÃd
(
ba£
, 
size
, 8))

217 
sw­_func
 = 
SWAP_WORDS_64
;

218 ià(
	`is_®igÃd
(
ba£
, 
size
, 4))

219 
sw­_func
 = 
SWAP_WORDS_32
;

221 
sw­_func
 = 
SWAP_BYTES
;

232 
size_t
 
b
, 
c
, 
d
;

234 ià(
a
)

235 
a
 -ğ
size
;

236 ià(
n
 -ğ
size
)

237 
	`do_sw­
(
ba£
, ba£ + 
n
, 
size
, 
sw­_func
);

253 
b
 = 
a
; 
c
 = 2*b + 
size
, (
d
 = c + sizeè< 
n
;)

254 
b
 = 
	`do_cmp
(
ba£
 + 
c
, ba£ + 
d
, 
cmp_func
, 
´iv
) >= 0 ? c : d;

255 ià(
d
 =ğ
n
)

256 
b
 = 
c
;

259 
b
 !ğ
a
 && 
	`do_cmp
(
ba£
 +‡, ba£ + b, 
cmp_func
, 
´iv
) >= 0)

260 
b
 = 
	`·»Á
(b, 
lsb™
, 
size
);

261 
c
 = 
b
;

262 
b
 !ğ
a
) {

263 
b
 = 
	`·»Á
(b, 
lsb™
, 
size
);

264 
	`do_sw­
(
ba£
 + 
b
, ba£ + 
c
, 
size
, 
sw­_func
);

267 
	}
}

269 
	$sÜt
(*
ba£
, 
size_t
 
num
, size_ˆ
size
,

270 
cmp_func_t
 
cmp_func
,

271 
sw­_func_t
 
sw­_func
)

273  
	`sÜt_r
(
ba£
, 
num
, 
size
, 
_CMP_WRAPPER
, 
sw­_func
, 
cmp_func
);

274 
	}
}

276 
	$cmpšt
(cÚ¡ *
a
, cÚ¡ *
b
)

278  *(*)
a
 - *(*)
b
;

279 
	}
}

281 
	#TEST_SIZE
 10000000

	)

283 
	$maš
() {

284 *
a
, 
i
, 
r
 = 1, 
”r
 = -1;

285 
timev®
 
¡¬t
, 
’d
;

286 
ru§ge
 
ru
;

288 
	`g‘timeofday
(&
¡¬t
, 
NULL
);

289 
a
 = 
	`m®loc
(
TEST_SIZE
 * ());

290 ià(!
a
)

291  
”r
;

293 
i
 = 0; i < 
TEST_SIZE
; i++) {

294 
r
 = 
	`¿nd
(è% 
TEST_SIZE
;

295 
a
[
i
] = 
r
;

298 
	`sÜt
(
a
, 
TEST_SIZE
, (*a), 
cmpšt
, 
NULL
);

300 
”r
 = -1;

301 
i
 = 0; i < 
TEST_SIZE
 - 1; i++)

302 ià(
a
[
i
] >‡[i + 1]) {

303 
	`´štf
("test has failed\n");

304 
ex™
;

306 
”r
 = 0;

307 
	`g‘timeofday
(&
’d
, 
NULL
);

308 
	`g‘ru§ge
(
RUSAGE_SELF
, &
ru
);

309 
	`´štf
("%.3g %.3g %.3g\n",

310 (
’d
.
tv_£c
 - 
¡¬t
.tv_£cè+ (’d.
tv_u£c
 - start.tv_usec) / 1e6,

311 
ru
.
ru_utime
.
tv_£c
 +„u.ru_utime.
tv_u£c
 / 1e6,

312 
ru
.
ru_¡ime
.
tv_£c
 +„u.ru_¡ime.
tv_u£c
 / 1e6);

314 
ex™
:

315 
	`ä“
(
a
);

316  
”r
;

317 
	}
}

	@performance/qsort/isort.c

1 
	~<as£¹.h
>

2 
	~<”ºo.h
>

3 
	~<”r.h
>

4 
	~<m©h.h
>

5 
	~<±h»ad.h
>

6 
	~<¡dboŞ.h
>

7 
	~<¡dio.h
>

8 
	~<¡dlib.h
>

9 
	~<¡ršg.h
>

10 
	~<¡dšt.h
>

11 
	~<sys/»sourû.h
>

12 
	~<sys/time.h
>

13 
	~<uni¡d.h
>

15 
	#v”ify
(
x
) \

17 
e
; \

18 ià((
e
 = 
x
) != 0) { \

19 
	`årštf
(
¡d”r
, "%s(%dè%s: %s\n", 
__FILE__
, 
__LINE__
, #x, \

20 
	`¡»¼Ü
(
e
)); \

21 
	`ex™
(1); \

23 } 0)

	)

25 
	tcmp_t
(cÚ¡ *
	ta
, cÚ¡ *
	tb
);

26 (*
	tcmp_func_t
)(cÚ¡ *
	ta
, cÚ¡ *
	tb
);

27 (*
	tsw­_func_t
)(*
	ta
, *
	tb
, 
	tsize
);

28 (*
	tcmp_r_func_t
)(cÚ¡ *
	ta
, cÚ¡ *
	tb
, cÚ¡ *
	t´iv
);

29 
šlše
 *
	`med3
(*, *, *, 
cmp_t
 *, *);

30 
šlše
 
	`sw­func
(*, *, , );

32 
	#mš
(
a
, 
b
) \

34 
	`ty³of
(
a
è
_a
 = (a); \

35 
	`ty³of
(
b
è
_b
 = (b); \

36 
_a
 < 
_b
 ? _a : _b; \

37 
	}
})

	)

40 
	#sw­code
(
TYPE
, 
·rmi
, 
·rmj
, 
n
) \

42 
i
 = (
n
è/ (
TYPE
); \

43 
TYPE
 *
pi
 = (TYPE *è(
·rmi
); \

44 
TYPE
 *
pj
 = (TYPE *è(
·rmj
); \

46 
TYPE
 
t
 = *
pi
; \

47 *
pi
++ = *
pj
; \

48 *
pj
++ = 
t
; \

49 } --
i
 > 0); \

50 }

	)

52 
šlše
 
	$sw­func
(*
a
, *
b
, 
n
, 
sw­ty³
)

54 ià(
sw­ty³
 <= 1)

55 
	`sw­code
(, 
a
, 
b
, 
n
) swapcode(,‡, b,‚)

56 
	}
}

58 
	#sw­
(
a
, 
b
) \

60 ià(
sw­ty³
 == 0) { \

61 
t
 = *(*è(
a
); \

62 *(*è(
a
èğ*(*è(
b
); \

63 *(*è(
b
èğ
t
; \

65 
	`sw­func
(
a
, 
b
, 
es
, 
sw­ty³
); \

66 } 0)

	)

68 
	#vecsw­
(
a
, 
b
, 
n
) \

70 ià((
n
) > 0) \

71 
	`sw­func
(
a
, 
b
, 
n
, 
sw­ty³
); \

72 } 0)

	)

74 
	#CMP
(
t
, 
x
, 
y
è(
	`cmp
((x), (y)))

	)

76 
šlše
 *
	$med3
(*
a
, *
b
, *
c
, 
cmp_t
 *
cmp
, *
thunk
)

78  
	`CMP
(
thunk
, 
a
, 
b
) < 0

79 ? (
	`CMP
(
thunk
, 
b
, 
c
è< 0 ? b : (CMPÑhunk, 
a
, c) < 0 ? c :‡))

80 : (
	`CMP
(
thunk
, 
b
, 
c
è> 0 ? b : (CMPÑhunk, 
a
, c) < 0 ?‡ : c));

81 
	}
}

84 
	eth»ad_¡©e
 {

85 
	mts_idË
,

86 
	mts_wÜk
,

87 
	mts_‹rm


91 
	sisÜt
 {

92 
th»ad_¡©e
 
	m¡
;

93 
commÚ
 *
	mcommÚ
;

94 *
	ma
;

95 
size_t
 
	mn
;

96 
	md•th
;

97 
±h»ad_t
 
	mid
;

98 
±h»ad_mu‹x_t
 
	mmtx_¡
;

99 
±h»ad_cÚd_t
 
	mcÚd_¡
;

103 
	scommÚ
 {

104 
	msw­ty³
;

105 
size_t
 
	mes
;

106 *
	mthunk
;

107 
cmp_t
 *
	mcmp
;

108 
	mÁh»ads
;

109 
	midËth»ads
;

110 
	mfÜk–em
;

111 
isÜt
 *
	mpoŞ
;

112 
±h»ad_mu‹x_t
 
	mmtx_®
;

115 *
isÜt_th»ad
(*
p
);

117 
boŞ
 
	$is_®igÃd
(cÚ¡ *
ba£
, 
size_t
 
size
, 
®ign
)

119 
lsb™s
 = ()
size
;

121 ()
ba£
;

122 #iâdeà
CONFIG_HAVE_EFFICIENT_UNALIGNED_ACCESS


123 
lsb™s
 |ğ()(
ušŒ_t
)
ba£
;

125  (
lsb™s
 & (
®ign
 - 1)) == 0;

126 
	}
}

128 
	$sw­_wÜds_32
(*
a
, *
b
, 
size_t
 
n
)

131 
ušt32_t
 
t
 = *(ušt32_ˆ*)(
a
 + (
n
 -= 4));

132 *(
ušt32_t
 *)(
a
 + 
n
èğ*(ušt32_ˆ*)(
b
 +‚);

133 *(
ušt32_t
 *)(
b
 + 
n
èğ
t
;

134 } 
n
);

135 
	}
}

137 
	$sw­_wÜds_64
(*
a
, *
b
, 
size_t
 
n
)

140 #ifdeà
CONFIG_64BIT


141 
ušt64_t
 
t
 = *(ušt64_ˆ*)(
a
 + (
n
 -= 8));

142 *(
ušt64_t
 *)(
a
 + 
n
èğ*(ušt64_ˆ*)(
b
 +‚);

143 *(
ušt64_t
 *)(
b
 + 
n
èğ
t
;

146 
ušt32_t
 
t
 = *(ušt32_ˆ*)(
a
 + (
n
 -= 4));

147 *(
ušt32_t
 *)(
a
 + 
n
èğ*(ušt32_ˆ*)(
b
 +‚);

148 *(
ušt32_t
 *)(
b
 + 
n
èğ
t
;

150 
t
 = *(
ušt32_t
 *)(
a
 + (
n
 -= 4));

151 *(
ušt32_t
 *)(
a
 + 
n
èğ*(ušt32_ˆ*)(
b
 +‚);

152 *(
ušt32_t
 *)(
b
 + 
n
èğ
t
;

154 } 
n
);

155 
	}
}

157 
	$sw­_by‹s
(*
a
, *
b
, 
size_t
 
n
)

160 
t
 = ((*)
a
)[--
n
];

161 ((*)
a
)[
n
] = ((*)
b
)[n];

162 ((*)
b
)[
n
] = 
t
;

163 } 
n
);

164 
	}
}

166 
	#SWAP_WORDS_64
 (
sw­_func_t
)0

	)

167 
	#SWAP_WORDS_32
 (
sw­_func_t
)1

	)

168 
	#SWAP_BYTES
 (
sw­_func_t
)2

	)

170 
	$do_sw­
(*
a
, *
b
, 
size_t
 
size
, 
sw­_func_t
 
sw­_func
)

172 ià(
sw­_func
 =ğ
SWAP_WORDS_64
)

173 
	`sw­_wÜds_64
(
a
, 
b
, 
size
);

174 ià(
sw­_func
 =ğ
SWAP_WORDS_32
)

175 
	`sw­_wÜds_32
(
a
, 
b
, 
size
);

176 ià(
sw­_func
 =ğ
SWAP_BYTES
)

177 
	`sw­_by‹s
(
a
, 
b
, 
size
);

179 
	`sw­_func
(
a
, 
b
, ()
size
);

180 
	}
}

182 
	#_CMP_WRAPPER
 ((
cmp_r_func_t
)0L)

	)

184 
	$do_cmp
(cÚ¡ *
a
, cÚ¡ *
b
, 
cmp_r_func_t
 
cmp
, cÚ¡ *
´iv
)

186 ià(
cmp
 =ğ
_CMP_WRAPPER
)

187  ()((
cmp_func_t
)(
´iv
))(
a
, 
b
);

188  
	`cmp
(
a
, 
b
, 
´iv
);

189 
	}
}

191 
	$cmpšt
(cÚ¡ *
a
, cÚ¡ *
b
)

193  *(*)
a
 - *(*)
b
;

194 
	}
}

195 
size_t
 
	$·»Á
(
size_t
 
i
, 
lsb™
, size_ˆ
size
)

197 
i
 -ğ
size
;

198 
i
 -ğ
size
 & -(˜& 
lsb™
);

199  
i
 / 2;

200 
	}
}

202 
	$h—p_sÜt
(*
ba£
, 
size_t
 
num
, size_ˆ
size
,

203 
cmp_r_func_t
 
cmp_func
,

204 
sw­_func_t
 
sw­_func
,

205 cÚ¡ *
´iv
)

208 
size_t
 
n
 = 
num
 * 
size
, 
a
 = (num/2) * size;

209 cÚ¡ 
lsb™
 = 
size
 & -size;

211 ià(!
a
)

214 ià(!
sw­_func
) {

215 ià(
	`is_®igÃd
(
ba£
, 
size
, 8))

216 
sw­_func
 = 
SWAP_WORDS_64
;

217 ià(
	`is_®igÃd
(
ba£
, 
size
, 4))

218 
sw­_func
 = 
SWAP_WORDS_32
;

220 
sw­_func
 = 
SWAP_BYTES
;

224 
size_t
 
b
, 
c
, 
d
;

226 ià(
a
)

227 
a
 -ğ
size
;

228 ià(
n
 -ğ
size
)

229 
	`do_sw­
(
ba£
, ba£ + 
n
, 
size
, 
sw­_func
);

233 
b
 = 
a
; 
c
 = 2*b + 
size
, (
d
 = c + sizeè< 
n
;)

234 
b
 = 
	`do_cmp
(
ba£
 + 
c
, ba£ + 
d
, 
cmp_func
, 
´iv
) >= 0 ? c : d;

235 ià(
d
 =ğ
n
)

236 
b
 = 
c
;

239 
b
 !ğ
a
 && 
	`do_cmp
(
ba£
 +‡, ba£ + b, 
cmp_func
, 
´iv
) >= 0)

240 
b
 = 
	`·»Á
(b, 
lsb™
, 
size
);

241 
c
 = 
b
;

242 
b
 !ğ
a
) {

243 
b
 = 
	`·»Á
(b, 
lsb™
, 
size
);

244 
	`do_sw­
(
ba£
 + 
b
, ba£ + 
c
, 
size
, 
sw­_func
);

247 
	}
}

251 
	$qsÜt_mt
(*
a
,

252 
size_t
 
n
,

253 
size_t
 
es
,

254 
cmp_t
 *
cmp
,

255 
maxth»ads
,

256 
fÜk–em
)

258 
isÜt
 *
qs
;

259 
commÚ
 
c
;

260 
i
, 
i¦Ù
;

261 
boŞ
 
baout
 = 
Œue
;

263 ià(
n
 < 
fÜk–em
)

264 
f1
;

265 
”ºo
 = 0;

267 ià(
	`±h»ad_mu‹x_š™
(&
c
.
mtx_®
, 
NULL
) != 0)

268 
f1
;

269 ià((
c
.
poŞ
 = 
	`ÿÎoc
(
maxth»ads
, (
isÜt
))è=ğ
NULL
)

270 
f2
;

271 
i¦Ù
 = 0; i¦Ù < 
maxth»ads
; islot++) {

272 
qs
 = &
c
.
poŞ
[
i¦Ù
];

273 ià(
	`±h»ad_mu‹x_š™
(&
qs
->
mtx_¡
, 
NULL
) != 0)

274 
f3
;

275 ià(
	`±h»ad_cÚd_š™
(&
qs
->
cÚd_¡
, 
NULL
) != 0) {

276 
	`v”ify
(
	`±h»ad_mu‹x_de¡roy
(&
qs
->
mtx_¡
));

277 
f3
;

279 
qs
->
¡
 = 
ts_idË
;

280 
qs
->
commÚ
 = &
c
;

281 
qs
->
d•th
 = 2 * 
	`log
(
n
);

282 ià(
	`±h»ad_ü—‹
(&
qs
->
id
, 
NULL
, 
isÜt_th»ad
, qs) != 0) {

283 
	`v”ify
(
	`±h»ad_mu‹x_de¡roy
(&
qs
->
mtx_¡
));

284 
	`v”ify
(
	`±h»ad_cÚd_de¡roy
(&
qs
->
cÚd_¡
));

285 
f3
;

290 
baout
 = 
çl£
;

293 
c
.
sw­ty³
 = ((*è
a
 - (*è0è% (è|| 
es
 % ()

295 : 
es
 == () ? 0

297 
c
.
es
 =ƒs;

298 
c
.
cmp
 = cmp;

299 
c
.
fÜk–em
 = forkelem;

300 
c
.
idËth»ads
 = c.
Áh»ads
 = 
maxth»ads
;

303 
qs
 = &
c
.
poŞ
[0];

304 
	`v”ify
(
	`±h»ad_mu‹x_lock
(&
qs
->
mtx_¡
));

305 
qs
->
a
 =‡;

306 
qs
->
n
 =‚;

307 
qs
->
¡
 = 
ts_wÜk
;

308 
c
.
idËth»ads
--;

309 
	`v”ify
(
	`±h»ad_cÚd_sigÇl
(&
qs
->
cÚd_¡
));

310 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
qs
->
mtx_¡
));

313 
f3
:

314 
i
 = 0; i < 
i¦Ù
; i++) {

315 
qs
 = &
c
.
poŞ
[
i
];

316 ià(
baout
) {

317 
	`v”ify
(
	`±h»ad_mu‹x_lock
(&
qs
->
mtx_¡
));

318 
qs
->
¡
 = 
ts_‹rm
;

319 
	`v”ify
(
	`±h»ad_cÚd_sigÇl
(&
qs
->
cÚd_¡
));

320 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
qs
->
mtx_¡
));

322 
	`v”ify
(
	`±h»ad_još
(
qs
->
id
, 
NULL
));

323 
	`v”ify
(
	`±h»ad_mu‹x_de¡roy
(&
qs
->
mtx_¡
));

324 
	`v”ify
(
	`±h»ad_cÚd_de¡roy
(&
qs
->
cÚd_¡
));

326 
	`ä“
(
c
.
poŞ
);

327 
f2
:

328 
	`v”ify
(
	`±h»ad_mu‹x_de¡roy
(&
c
.
mtx_®
));

329 ià(
baout
) {

330 
	`årštf
(
¡d”r
, "Resource initialization failed; bailing out.\n");

331 
f1
:

332 
	`qsÜt
(
a
, 
n
, 
es
, 
cmp
);

334 
	}
}

336 
	#thunk
 
NULL


	)

337 
	#INSERT_SIZE
 7

	)

343 
isÜt
 *
	$®loÿ‹_th»ad
(
commÚ
 *
c
)

345 
	`v”ify
(
	`±h»ad_mu‹x_lock
(&
c
->
mtx_®
));

346 
i
 = 0; i < 
c
->
Áh»ads
; i++)

347 ià(
c
->
poŞ
[
i
].
¡
 =ğ
ts_idË
) {

348 
	`v”ify
(
	`±h»ad_mu‹x_lock
(&
c
->
poŞ
[
i
].
mtx_¡
));

349 
c
->
idËth»ads
--;

350 
c
->
poŞ
[
i
].
¡
 = 
ts_wÜk
;

351 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
c
->
mtx_®
));

352  (&
c
->
poŞ
[
i
]);

354 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
c
->
mtx_®
));

355  (
NULL
);

356 
	}
}

359 
	$isÜt_®go
(
isÜt
 *
qs
)

361 *
·
, *
pb
, *
pc
, *
pd
, *
¶
, *
pm
, *
²
;

362 
d
, 
r
, 
sw­ty³
, 
sw­_út
, 
d•th
;

363 *
a
;

364 
size_t
 
n
, 
es
;

365 
cmp_t
 *
cmp
;

366 
Æ
, 
Ä
;

367 
commÚ
 *
c
;

368 
isÜt
 *
qs2
;

371 
c
 = 
qs
->
commÚ
;

372 
es
 = 
c
->es;

373 
cmp
 = 
c
->cmp;

374 
sw­ty³
 = 
c
->swaptype;

375 
a
 = 
qs
->a;

376 
n
 = 
qs
->n;

377 
d•th
 = 
qs
->depth;

379 
tİ
:

381 
sw­_út
 = 0;

382 ià(
n
 < 
INSERT_SIZE
) {

384 
pm
 = (*è
a
 + 
es
;…m < (*è¨+ 
n
 *ƒs;…m +=ƒs)

385 
¶
 = 
pm
;…È> (*è
a
 && 
	`CMP
(
thunk
,…È- 
es
,…l) > 0;

386 
¶
 -ğ
es
)

387 
	`sw­
(
¶
,…È- 
es
);

390 if(
d•th
 == 0)

393 
	`h—p_sÜt
(
a
, 
n
, 
es
, 
_CMP_WRAPPER
, 
NULL
, 
cmpšt
);

397 
pm
 = (*è
a
 + (
n
 / 2è* 
es
;

398 ià(
n
 > 
INSERT_SIZE
) {

399 
¶
 = (*è
a
;

400 
²
 = (*è
a
 + (
n
 - 1è* 
es
;

401 ià(
n
 > 40) {

402 
d
 = (
n
 / 8è* 
es
;

403 
¶
 = 
	`med3
Õl,…È+ 
d
,…È+ 2 * d, 
cmp
, 
thunk
);

404 
pm
 = 
	`med3
Õm - 
d
,…m,…m + d, 
cmp
, 
thunk
);

405 
²
 = 
	`med3
ÕÀ- 2 * 
d
,…À- d,…n, 
cmp
, 
thunk
);

407 
pm
 = 
	`med3
(
¶
,…m, 
²
, 
cmp
, 
thunk
);

409 
	`sw­
(
a
, 
pm
);

410 
·
 = 
pb
 = (*è
a
 + 
es
;

411 
pc
 = 
pd
 = (*è
a
 + (
n
 - 1è* 
es
;

414 
pb
 <ğ
pc
 && (
r
 = 
	`CMP
(
thunk
,…b, 
a
)) <= 0) {

415 ià(
r
 == 0) {

416 
sw­_út
 = 1;

417 
	`sw­
(
·
, 
pb
);

418 
·
 +ğ
es
;

420 
pb
 +ğ
es
;

422 
pb
 <ğ
pc
 && (
r
 = 
	`CMP
(
thunk
,…c, 
a
)) >= 0) {

423 ià(
r
 == 0) {

424 
sw­_út
 = 1;

425 
	`sw­
(
pc
, 
pd
);

426 
pd
 -ğ
es
;

428 
pc
 -ğ
es
;

430 ià(
pb
 > 
pc
)

432 
	`sw­
(
pb
, 
pc
);

433 
sw­_út
 = 1;

434 
pb
 +ğ
es
;

435 
pc
 -ğ
es
;

438 
²
 = (*è
a
 + 
n
 * 
es
;

439 
r
 = 
	`mš
(
·
 - (*è
a
, 
pb
 -…a);

440 
	`vecsw­
(
a
, 
pb
 - 
r
,„);

441 
r
 = 
	`mš
(
pd
 - 
pc
, 
²
 -…d - 
es
);

442 
	`vecsw­
(
pb
, 
²
 - 
r
,„);

444 ià(
sw­_út
 == 0) {

445 
r
 = 1 + 
n
 / 4;

446 
pm
 = (*è
a
 + 
es
;…m < (*è¨+ 
n
 *ƒs;…m +=ƒs)

447 
¶
 = 
pm
;…È> (*è
a
 && 
	`CMP
(
thunk
,…È- 
es
,…l) > 0;

448 
¶
 -ğ
es
) {

449 
	`sw­
(
¶
,…È- 
es
);

450 ià(++
sw­_út
 > 
r
)

451 
Ãv”mšd
;

456 
Ãv”mšd
:

457 
Æ
 = (
pb
 - 
·
è/ 
es
;

458 
Ä
 = (
pd
 - 
pc
è/ 
es
;

461 ià(
Æ
 > 
c
->
fÜk–em
 && 
Ä
 > c->forkelem &&

462 (
qs2
 = 
	`®loÿ‹_th»ad
(
c
)è!ğ
NULL
) {

463 
qs2
->
a
 =‡;

464 
qs2
->
n
 = 
Æ
;

465 
qs2
->
d•th
 = depth - 1;

466 
	`v”ify
(
	`±h»ad_cÚd_sigÇl
(&
qs2
->
cÚd_¡
));

467 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
qs2
->
mtx_¡
));

468 } ià(
Æ
 > 0) {

469 
qs
->
a
 =‡;

470 
qs
->
n
 = 
Æ
;

471 
qs
->
d•th
 = depth - 1;

472 
	`isÜt_®go
(
qs
);

474 ià(
Ä
 > 0) {

475 
a
 = 
²
 - 
Ä
 * 
es
;

476 
n
 = 
Ä
;

477 
d•th
 -= 1;

478 
tİ
;

480 
	}
}

483 *
	$isÜt_th»ad
(*
p
)

485 
isÜt
 *
qs
, *
qs2
;

486 
i
;

487 
commÚ
 *
c
;

489 
qs
 = 
p
;

490 
c
 = 
qs
->
commÚ
;

491 
agaš
:

493 
	`v”ify
(
	`±h»ad_mu‹x_lock
(&
qs
->
mtx_¡
));

494 
qs
->
¡
 =ğ
ts_idË
)

495 
	`v”ify
(
	`±h»ad_cÚd_wa™
(&
qs
->
cÚd_¡
, &qs->
mtx_¡
));

496 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
qs
->
mtx_¡
));

497 ià(
qs
->
¡
 =ğ
ts_‹rm
) {

498  
NULL
;

500 
	`as£¹
(
qs
->
¡
 =ğ
ts_wÜk
);

502 
	`isÜt_®go
(
qs
);

504 
	`v”ify
(
	`±h»ad_mu‹x_lock
(&
c
->
mtx_®
));

505 
qs
->
¡
 = 
ts_idË
;

506 
c
->
idËth»ads
++;

507 ià(
c
->
idËth»ads
 =ğc->
Áh»ads
) {

508 
i
 = 0; i < 
c
->
Áh»ads
; i++) {

509 
qs2
 = &
c
->
poŞ
[
i
];

510 ià(
qs2
 =ğ
qs
)

512 
	`v”ify
(
	`±h»ad_mu‹x_lock
(&
qs2
->
mtx_¡
));

513 
qs2
->
¡
 = 
ts_‹rm
;

514 
	`v”ify
(
	`±h»ad_cÚd_sigÇl
(&
qs2
->
cÚd_¡
));

515 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
qs2
->
mtx_¡
));

517 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
c
->
mtx_®
));

518  
NULL
;

520 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
c
->
mtx_®
));

521 
agaš
;

522 
	}
}

524 #iâdeà
ELEM_T


525 
	#ELEM_T
 
ušt32_t


	)

528 
	$num_com·»
(cÚ¡ *
a
, cÚ¡ *
b
)

530  (*(
ELEM_T
 *è
a
 - *(ELEM_T *è
b
);

531 
	}
}

533 
	$¡ršg_com·»
(cÚ¡ *
a
, cÚ¡ *
b
)

535  
	`¡rcmp
(*(**è
a
, *(**è
b
);

536 
	}
}

538 *
	$xm®loc
(
size_t
 
s
)

540 *
p
;

542 ià((
p
 = 
	`m®loc
(
s
)è=ğ
NULL
) {

543 
	`³¼Ü
("malloc");

544 
	`ex™
(1);

546  (
p
);

547 
	}
}

549 
	$u§ge
()

551 
	`årštf
(

552 
¡d”r
,

559 
	`ex™
(1);

560 
	}
}

562 
	$maš
(
¬gc
, *
¬gv
[])

564 
boŞ
 
İt_¡r
 = 
çl£
;

565 
boŞ
 
İt_time
 = 
çl£
;

566 
boŞ
 
İt_v”ify
 = 
çl£
;

567 
boŞ
 
İt_libc
 = 
çl£
;

568 
ch
, 
i
;

569 
size_t
 
ÃËm
 = 50000000;

570 
th»ads
 = 2;

571 
fÜk–em’ts
 = 100;

572 
ELEM_T
 *
št_–em
;

573 *
•
;

574 **
¡r_–em
;

575 
timev®
 
¡¬t
, 
’d
;

576 
ru§ge
 
ru
;

578 
	`g‘timeofday
(&
¡¬t
, 
NULL
);

579 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "f:h:ln:stv")) != -1) {

580 
ch
) {

582 
fÜk–em’ts
 = (è
	`¡¹Ş
(
İrg
, &
•
, 10);

583 ià(
fÜk–em’ts
 <ğ0 || *
•
 != '\0') {

584 
	`w¬nx
("Ëg®‚umb”, -à¬gum’ˆ-- %s", 
İrg
);

585 
	`u§ge
();

589 
th»ads
 = (è
	`¡¹Ş
(
İrg
, &
•
, 10);

590 ià(
th»ads
 < 0 || *
•
 != '\0') {

591 
	`w¬nx
("Ëg®‚umb”, -h‡rgum’ˆ-- %s", 
İrg
);

592 
	`u§ge
();

596 
İt_libc
 = 
Œue
;

599 
ÃËm
 = (
size_t
è
	`¡¹Ş
(
İrg
, &
•
, 10);

600 ià(
ÃËm
 =ğ0 || *
•
 != '\0') {

601 
	`w¬nx
("Ëg®‚umb”, -À¬gum’ˆ-- %s", 
İrg
);

602 
	`u§ge
();

606 
İt_¡r
 = 
Œue
;

609 
İt_time
 = 
Œue
;

612 
İt_v”ify
 = 
Œue
;

616 
	`u§ge
();

620 ià(
İt_v”ify
 && 
İt_¡r
)

621 
	`u§ge
();

623 
¬gc
 -ğ
İtšd
;

624 
¬gv
 +ğ
İtšd
;

626 ià(
İt_¡r
) {

627 
¡r_–em
 = 
	`xm®loc
(
ÃËm
 * (*));

628 
i
 = 0; i < 
ÃËm
; i++)

629 ià(
	`a¥rštf
(&
¡r_–em
[
i
], "%d%d", 
	`¿nd
(),„and()) == -1) {

630 
	`³¼Ü
("asprintf");

631 
	`ex™
(1);

634 
št_–em
 = 
	`xm®loc
(
ÃËm
 * (
ELEM_T
));

635 
i
 = 0; i < 
ÃËm
; i++)

636 
št_–em
[
i
] = 
	`¿nd
(è% 
ÃËm
;

638 ià(
İt_¡r
) {

639 ià(
İt_libc
)

640 
	`qsÜt
(
¡r_–em
, 
ÃËm
, (*), 
¡ršg_com·»
);

642 
	`qsÜt_mt
(
¡r_–em
, 
ÃËm
, (*), 
¡ršg_com·»
, 
th»ads
,

643 
fÜk–em’ts
);

645 ià(
İt_libc
)

646 
	`qsÜt
(
št_–em
, 
ÃËm
, (
ELEM_T
), 
num_com·»
);

648 
	`qsÜt_mt
(
št_–em
, 
ÃËm
, (
ELEM_T
), 
num_com·»
, 
th»ads
,

649 
fÜk–em’ts
);

651 
	`g‘timeofday
(&
’d
, 
NULL
);

652 
	`g‘ru§ge
(
RUSAGE_SELF
, &
ru
);

653 ià(
İt_v”ify
) {

654 
i
 = 1; i < 
ÃËm
; i++)

655 ià(
št_–em
[
i
 - 1] > int_elem[i]) {

656 
	`årštf
(
¡d”r
,

659 
i
, 
št_–em
[i - 1], int_elem[i]);

660 
	`ex™
(2);

663 ià(
İt_time
)

664 
	`´štf
(

666 (
’d
.
tv_£c
 - 
¡¬t
.tv_£cè+ (’d.
tv_u£c
 - start.tv_usec) / 1e6,

667 
ru
.
ru_utime
.
tv_£c
 +„u.ru_utime.
tv_u£c
 / 1e6,

668 
ru
.
ru_¡ime
.
tv_£c
 +„u.ru_¡ime.
tv_u£c
 / 1e6);

670 
	}
}

	@performance/qsort/qsort.c

1 
	~<as£¹.h
>

2 
	~<”ºo.h
>

3 
	~<±h»ad.h
>

4 
	~<¡dboŞ.h
>

5 
	~<¡dio.h
>

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

9 
	#v”ify
(
x
) \

11 
e
; \

12 ià((
e
 = 
x
) != 0) { \

13 
	`årštf
(
¡d”r
, "%s(%dè%s: %s\n", 
__FILE__
, 
__LINE__
, #x, \

14 
	`¡»¼Ü
(
e
)); \

15 
	`ex™
(1); \

17 } 0)

	)

19 
	tcmp_t
(const *, const *);

20 
šlše
 *
med3
(*, *, *, 
cmp_t
 *, *);

21 
šlše
 
sw­func
(*, *, , );

23 
	#mš
(
a
, 
b
) \

25 
	`ty³of
(
a
è
_a
 = (a); \

26 
	`ty³of
(
b
è
_b
 = (b); \

27 
_a
 < 
_b
 ? _a : _b; \

28 })

	)

31 
	#sw­code
(
TYPE
, 
·rmi
, 
·rmj
, 
n
) \

33 
i
 = (
n
è/ (
TYPE
); \

34 
TYPE
 *
pi
 = (TYPE *è(
·rmi
); \

35 
TYPE
 *
pj
 = (TYPE *è(
·rmj
); \

37 
TYPE
 
t
 = *
pi
; \

38 *
pi
++ = *
pj
; \

39 *
pj
++ = 
t
; \

40 } --
i
 > 0); \

41 }

	)

43 
šlše
 
	$sw­func
(*
a
, *
b
, 
n
, 
sw­ty³
)

45 ià(
sw­ty³
 <= 1)

46 
	`sw­code
(, 
a
, 
b
, 
n
) swapcode(,‡, b,‚)

47 
	}
}

49 
	#sw­
(
a
, 
b
) \

51 ià(
sw­ty³
 == 0) { \

52 
t
 = *(*è(
a
); \

53 *(*è(
a
èğ*(*è(
b
); \

54 *(*è(
b
èğ
t
; \

56 
	`sw­func
(
a
, 
b
, 
es
, 
sw­ty³
); \

57 } 0)

	)

59 
	#vecsw­
(
a
, 
b
, 
n
) \

61 ià((
n
) > 0) \

62 
	`sw­func
(
a
, 
b
, 
n
, 
sw­ty³
); \

63 } 0)

	)

65 
	#CMP
(
t
, 
x
, 
y
è(
	`cmp
((x), (y)))

	)

67 
šlše
 *
	$med3
(*
a
, *
b
, *
c
, 
cmp_t
 *
cmp
, *
thunk
)

69  
	`CMP
(
thunk
, 
a
, 
b
) < 0

70 ? (
	`CMP
(
thunk
, 
b
, 
c
è< 0 ? b : (CMPÑhunk, 
a
, c) < 0 ? c :‡))

71 : (
	`CMP
(
thunk
, 
b
, 
c
è> 0 ? b : (CMPÑhunk, 
a
, c) < 0 ?‡ : c));

72 
	}
}

81 
	eth»ad_¡©e
 {

82 
	mts_idË
,

83 
	mts_wÜk
,

84 
	mts_‹rm


88 
	sqsÜt
 {

89 
th»ad_¡©e
 
	m¡
;

90 
commÚ
 *
	mcommÚ
;

91 *
	ma
;

92 
size_t
 
	mn
;

93 
±h»ad_t
 
	mid
;

94 
±h»ad_mu‹x_t
 
	mmtx_¡
;

95 
±h»ad_cÚd_t
 
	mcÚd_¡
;

99 
	scommÚ
 {

100 
	msw­ty³
;

101 
size_t
 
	mes
;

102 *
	mthunk
;

103 
cmp_t
 *
	mcmp
;

104 
	mÁh»ads
;

105 
	midËth»ads
;

106 
	mfÜk–em
;

107 
qsÜt
 *
	mpoŞ
;

108 
±h»ad_mu‹x_t
 
	mmtx_®
;

111 *
qsÜt_th»ad
(*
p
);

114 
	$qsÜt_mt
(*
a
,

115 
size_t
 
n
,

116 
size_t
 
es
,

117 
cmp_t
 *
cmp
,

118 
maxth»ads
,

119 
fÜk–em
)

121 
qsÜt
 *
qs
;

122 
commÚ
 
c
;

123 
i
, 
i¦Ù
;

124 
boŞ
 
baout
 = 
Œue
;

126 ià(
n
 < 
fÜk–em
)

127 
f1
;

128 
”ºo
 = 0;

130 ià(
	`±h»ad_mu‹x_š™
(&
c
.
mtx_®
, 
NULL
) != 0)

131 
f1
;

132 ià((
c
.
poŞ
 = 
	`ÿÎoc
(
maxth»ads
, (
qsÜt
))è=ğ
NULL
)

133 
f2
;

134 
i¦Ù
 = 0; i¦Ù < 
maxth»ads
; islot++) {

135 
qs
 = &
c
.
poŞ
[
i¦Ù
];

136 ià(
	`±h»ad_mu‹x_š™
(&
qs
->
mtx_¡
, 
NULL
) != 0)

137 
f3
;

138 ià(
	`±h»ad_cÚd_š™
(&
qs
->
cÚd_¡
, 
NULL
) != 0) {

139 
	`v”ify
(
	`±h»ad_mu‹x_de¡roy
(&
qs
->
mtx_¡
));

140 
f3
;

142 
qs
->
¡
 = 
ts_idË
;

143 
qs
->
commÚ
 = &
c
;

144 ià(
	`±h»ad_ü—‹
(&
qs
->
id
, 
NULL
, 
qsÜt_th»ad
, qs) != 0) {

145 
	`v”ify
(
	`±h»ad_mu‹x_de¡roy
(&
qs
->
mtx_¡
));

146 
	`v”ify
(
	`±h»ad_cÚd_de¡roy
(&
qs
->
cÚd_¡
));

147 
f3
;

152 
baout
 = 
çl£
;

155 
c
.
sw­ty³
 = ((*è
a
 - (*è0è% (è|| 
es
 % ()

157 : 
es
 == () ? 0

159 
c
.
es
 =ƒs;

160 
c
.
cmp
 = cmp;

161 
c
.
fÜk–em
 = forkelem;

162 
c
.
idËth»ads
 = c.
Áh»ads
 = 
maxth»ads
;

165 
qs
 = &
c
.
poŞ
[0];

166 
	`v”ify
(
	`±h»ad_mu‹x_lock
(&
qs
->
mtx_¡
));

167 
qs
->
a
 =‡;

168 
qs
->
n
 =‚;

169 
qs
->
¡
 = 
ts_wÜk
;

170 
c
.
idËth»ads
--;

171 
	`v”ify
(
	`±h»ad_cÚd_sigÇl
(&
qs
->
cÚd_¡
));

172 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
qs
->
mtx_¡
));

175 
f3
:

176 
i
 = 0; i < 
i¦Ù
; i++) {

177 
qs
 = &
c
.
poŞ
[
i
];

178 ià(
baout
) {

179 
	`v”ify
(
	`±h»ad_mu‹x_lock
(&
qs
->
mtx_¡
));

180 
qs
->
¡
 = 
ts_‹rm
;

181 
	`v”ify
(
	`±h»ad_cÚd_sigÇl
(&
qs
->
cÚd_¡
));

182 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
qs
->
mtx_¡
));

184 
	`v”ify
(
	`±h»ad_još
(
qs
->
id
, 
NULL
));

185 
	`v”ify
(
	`±h»ad_mu‹x_de¡roy
(&
qs
->
mtx_¡
));

186 
	`v”ify
(
	`±h»ad_cÚd_de¡roy
(&
qs
->
cÚd_¡
));

188 
	`ä“
(
c
.
poŞ
);

189 
f2
:

190 
	`v”ify
(
	`±h»ad_mu‹x_de¡roy
(&
c
.
mtx_®
));

191 ià(
baout
) {

192 
	`årštf
(
¡d”r
, "Resource initialization failed; bailing out.\n");

193 
f1
:

194 
	`qsÜt
(
a
, 
n
, 
es
, 
cmp
);

196 
	}
}

198 
	#thunk
 
NULL


	)

205 
qsÜt
 *
	$®loÿ‹_th»ad
(
commÚ
 *
c
)

207 
	`v”ify
(
	`±h»ad_mu‹x_lock
(&
c
->
mtx_®
));

208 
i
 = 0; i < 
c
->
Áh»ads
; i++)

209 ià(
c
->
poŞ
[
i
].
¡
 =ğ
ts_idË
) {

210 
	`v”ify
(
	`±h»ad_mu‹x_lock
(&
c
->
poŞ
[
i
].
mtx_¡
));

211 
c
->
idËth»ads
--;

212 
c
->
poŞ
[
i
].
¡
 = 
ts_wÜk
;

213 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
c
->
mtx_®
));

214  (&
c
->
poŞ
[
i
]);

216 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
c
->
mtx_®
));

217  (
NULL
);

218 
	}
}

221 
	$qsÜt_®go
(
qsÜt
 *
qs
)

223 *
·
, *
pb
, *
pc
, *
pd
, *
¶
, *
pm
, *
²
;

224 
d
, 
r
, 
sw­ty³
, 
sw­_út
;

225 *
a
;

226 
size_t
 
n
, 
es
;

227 
cmp_t
 *
cmp
;

228 
Æ
, 
Ä
;

229 
commÚ
 *
c
;

230 
qsÜt
 *
qs2
;

233 
c
 = 
qs
->
commÚ
;

234 
es
 = 
c
->es;

235 
cmp
 = 
c
->cmp;

236 
sw­ty³
 = 
c
->swaptype;

237 
a
 = 
qs
->a;

238 
n
 = 
qs
->n;

239 
tİ
:

241 
sw­_út
 = 0;

242 ià(
n
 < 7) {

243 
pm
 = (*è
a
 + 
es
;…m < (*è¨+ 
n
 *ƒs;…m +=ƒs)

244 
¶
 = 
pm
;…È> (*è
a
 && 
	`CMP
(
thunk
,…È- 
es
,…l) > 0;

245 
¶
 -ğ
es
)

246 
	`sw­
(
¶
,…È- 
es
);

249 
pm
 = (*è
a
 + (
n
 / 2è* 
es
;

250 ià(
n
 > 7) {

251 
¶
 = (*è
a
;

252 
²
 = (*è
a
 + (
n
 - 1è* 
es
;

253 ià(
n
 > 40) {

254 
d
 = (
n
 / 8è* 
es
;

255 
¶
 = 
	`med3
Õl,…È+ 
d
,…È+ 2 * d, 
cmp
, 
thunk
);

256 
pm
 = 
	`med3
Õm - 
d
,…m,…m + d, 
cmp
, 
thunk
);

257 
²
 = 
	`med3
ÕÀ- 2 * 
d
,…À- d,…n, 
cmp
, 
thunk
);

259 
pm
 = 
	`med3
(
¶
,…m, 
²
, 
cmp
, 
thunk
);

261 
	`sw­
(
a
, 
pm
);

262 
·
 = 
pb
 = (*è
a
 + 
es
;

264 
pc
 = 
pd
 = (*è
a
 + (
n
 - 1è* 
es
;

266 
pb
 <ğ
pc
 && (
r
 = 
	`CMP
(
thunk
,…b, 
a
)) <= 0) {

267 ià(
r
 == 0) {

268 
sw­_út
 = 1;

269 
	`sw­
(
·
, 
pb
);

270 
·
 +ğ
es
;

272 
pb
 +ğ
es
;

274 
pb
 <ğ
pc
 && (
r
 = 
	`CMP
(
thunk
,…c, 
a
)) >= 0) {

275 ià(
r
 == 0) {

276 
sw­_út
 = 1;

277 
	`sw­
(
pc
, 
pd
);

278 
pd
 -ğ
es
;

280 
pc
 -ğ
es
;

282 ià(
pb
 > 
pc
)

284 
	`sw­
(
pb
, 
pc
);

285 
sw­_út
 = 1;

286 
pb
 +ğ
es
;

287 
pc
 -ğ
es
;

290 
²
 = (*è
a
 + 
n
 * 
es
;

291 
r
 = 
	`mš
(
·
 - (*è
a
, 
pb
 -…a);

292 
	`vecsw­
(
a
, 
pb
 - 
r
,„);

293 
r
 = 
	`mš
(
pd
 - 
pc
, 
²
 -…d - 
es
);

294 
	`vecsw­
(
pb
, 
²
 - 
r
,„);

296 ià(
sw­_út
 == 0) {

297 
r
 = 1 + 
n
 / 4;

298 
pm
 = (*è
a
 + 
es
;…m < (*è¨+ 
n
 *ƒs;…m +=ƒs)

299 
¶
 = 
pm
;…È> (*è
a
 && 
	`CMP
(
thunk
,…È- 
es
,…l) > 0;

300 
¶
 -ğ
es
) {

301 
	`sw­
(
¶
,…È- 
es
);

302 ià(++
sw­_út
 > 
r
)

303 
Ãv”mšd
;

308 
Ãv”mšd
:

309 
Æ
 = (
pb
 - 
·
è/ 
es
;

310 
Ä
 = (
pd
 - 
pc
è/ 
es
;

313 ià(
Æ
 > 
c
->
fÜk–em
 && 
Ä
 > c->forkelem &&

314 (
qs2
 = 
	`®loÿ‹_th»ad
(
c
)è!ğ
NULL
) {

315 
qs2
->
a
 =‡;

316 
qs2
->
n
 = 
Æ
;

317 
	`v”ify
(
	`±h»ad_cÚd_sigÇl
(&
qs2
->
cÚd_¡
));

318 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
qs2
->
mtx_¡
));

319 } ià(
Æ
 > 0) {

320 
qs
->
a
 =‡;

321 
qs
->
n
 = 
Æ
;

322 
	`qsÜt_®go
(
qs
);

324 ià(
Ä
 > 0) {

325 
a
 = 
²
 - 
Ä
 * 
es
;

326 
n
 = 
Ä
;

327 
tİ
;

329 
	}
}

332 *
	$qsÜt_th»ad
(*
p
)

334 
qsÜt
 *
qs
, *
qs2
;

335 
i
;

336 
commÚ
 *
c
;

338 
qs
 = 
p
;

339 
c
 = 
qs
->
commÚ
;

340 
agaš
:

342 
	`v”ify
(
	`±h»ad_mu‹x_lock
(&
qs
->
mtx_¡
));

343 
qs
->
¡
 =ğ
ts_idË
)

344 
	`v”ify
(
	`±h»ad_cÚd_wa™
(&
qs
->
cÚd_¡
, &qs->
mtx_¡
));

345 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
qs
->
mtx_¡
));

346 ià(
qs
->
¡
 =ğ
ts_‹rm
) {

347  
NULL
;

349 
	`as£¹
(
qs
->
¡
 =ğ
ts_wÜk
);

351 
	`qsÜt_®go
(
qs
);

353 
	`v”ify
(
	`±h»ad_mu‹x_lock
(&
c
->
mtx_®
));

354 
qs
->
¡
 = 
ts_idË
;

355 
c
->
idËth»ads
++;

356 ià(
c
->
idËth»ads
 =ğc->
Áh»ads
) {

357 
i
 = 0; i < 
c
->
Áh»ads
; i++) {

358 
qs2
 = &
c
->
poŞ
[
i
];

359 ià(
qs2
 =ğ
qs
)

361 
	`v”ify
(
	`±h»ad_mu‹x_lock
(&
qs2
->
mtx_¡
));

362 
qs2
->
¡
 = 
ts_‹rm
;

363 
	`v”ify
(
	`±h»ad_cÚd_sigÇl
(&
qs2
->
cÚd_¡
));

364 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
qs2
->
mtx_¡
));

366 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
c
->
mtx_®
));

367  
NULL
;

369 
	`v”ify
(
	`±h»ad_mu‹x_uÆock
(&
c
->
mtx_®
));

370 
agaš
;

371 
	}
}

373 
	~<”r.h
>

374 
	~<¡dšt.h
>

375 
	~<sys/»sourû.h
>

376 
	~<sys/time.h
>

377 
	~<uni¡d.h
>

379 #iâdeà
ELEM_T


380 
	#ELEM_T
 
ušt32_t


	)

383 
	$num_com·»
(cÚ¡ *
a
, cÚ¡ *
b
)

385  (*(
ELEM_T
 *è
a
 - *(ELEM_T *è
b
);

386 
	}
}

388 
	$¡ršg_com·»
(cÚ¡ *
a
, cÚ¡ *
b
)

390  
	`¡rcmp
(*(**è
a
, *(**è
b
);

391 
	}
}

393 *
	$xm®loc
(
size_t
 
s
)

395 *
p
;

397 ià((
p
 = 
	`m®loc
(
s
)è=ğ
NULL
) {

398 
	`³¼Ü
("malloc");

399 
	`ex™
(1);

401  (
p
);

402 
	}
}

404 
	$u§ge
()

406 
	`årštf
(

407 
¡d”r
,

414 
	`ex™
(1);

415 
	}
}

417 
	$maš
(
¬gc
, *
¬gv
[])

419 
boŞ
 
İt_¡r
 = 
çl£
;

420 
boŞ
 
İt_time
 = 
çl£
;

421 
boŞ
 
İt_v”ify
 = 
çl£
;

422 
boŞ
 
İt_libc
 = 
çl£
;

423 
ch
, 
i
;

424 
size_t
 
ÃËm
 = 10000000;

425 
th»ads
 = 2;

426 
fÜk–em’ts
 = 100;

427 
ELEM_T
 *
št_–em
;

428 *
•
;

429 **
¡r_–em
;

430 
timev®
 
¡¬t
, 
’d
;

431 
ru§ge
 
ru
;

433 
	`g‘timeofday
(&
¡¬t
, 
NULL
);

434 (
ch
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "f:h:ln:stv")) != -1) {

435 
ch
) {

437 
fÜk–em’ts
 = (è
	`¡¹Ş
(
İrg
, &
•
, 10);

438 ià(
fÜk–em’ts
 <ğ0 || *
•
 != '\0') {

439 
	`w¬nx
("Ëg®‚umb”, -à¬gum’ˆ-- %s", 
İrg
);

440 
	`u§ge
();

444 
th»ads
 = (è
	`¡¹Ş
(
İrg
, &
•
, 10);

445 ià(
th»ads
 < 0 || *
•
 != '\0') {

446 
	`w¬nx
("Ëg®‚umb”, -h‡rgum’ˆ-- %s", 
İrg
);

447 
	`u§ge
();

451 
İt_libc
 = 
Œue
;

454 
ÃËm
 = (
size_t
è
	`¡¹Ş
(
İrg
, &
•
, 10);

455 ià(
ÃËm
 =ğ0 || *
•
 != '\0') {

456 
	`w¬nx
("Ëg®‚umb”, -À¬gum’ˆ-- %s", 
İrg
);

457 
	`u§ge
();

461 
İt_¡r
 = 
Œue
;

464 
İt_time
 = 
Œue
;

467 
İt_v”ify
 = 
Œue
;

471 
	`u§ge
();

475 ià(
İt_v”ify
 && 
İt_¡r
)

476 
	`u§ge
();

478 
¬gc
 -ğ
İtšd
;

479 
¬gv
 +ğ
İtšd
;

481 ià(
İt_¡r
) {

482 
¡r_–em
 = 
	`xm®loc
(
ÃËm
 * (*));

483 
i
 = 0; i < 
ÃËm
; i++)

484 ià(
	`a¥rštf
(&
¡r_–em
[
i
], "%d%d", 
	`¿nd
(),„and()) == -1) {

485 
	`³¼Ü
("asprintf");

486 
	`ex™
(1);

489 
št_–em
 = 
	`xm®loc
(
ÃËm
 * (
ELEM_T
));

490 
i
 = 0; i < 
ÃËm
; i++)

491 
št_–em
[
i
] = 
	`¿nd
(è% 
ÃËm
;

493 ià(
İt_¡r
) {

494 ià(
İt_libc
)

495 
	`qsÜt
(
¡r_–em
, 
ÃËm
, (*), 
¡ršg_com·»
);

497 
	`qsÜt_mt
(
¡r_–em
, 
ÃËm
, (*), 
¡ršg_com·»
, 
th»ads
,

498 
fÜk–em’ts
);

500 ià(
İt_libc
)

501 
	`qsÜt
(
št_–em
, 
ÃËm
, (
ELEM_T
), 
num_com·»
);

503 
	`qsÜt_mt
(
št_–em
, 
ÃËm
, (
ELEM_T
), 
num_com·»
, 
th»ads
,

504 
fÜk–em’ts
);

506 
	`g‘timeofday
(&
’d
, 
NULL
);

507 
	`g‘ru§ge
(
RUSAGE_SELF
, &
ru
);

508 ià(
İt_v”ify
) {

509 
i
 = 1; i < 
ÃËm
; i++)

510 ià(
št_–em
[
i
 - 1] > int_elem[i]) {

511 
	`årštf
(
¡d”r
,

514 
i
, 
št_–em
[i - 1], int_elem[i]);

515 
	`ex™
(2);

518 ià(
İt_time
)

519 
	`´štf
(

521 (
’d
.
tv_£c
 - 
¡¬t
.tv_£cè+ (’d.
tv_u£c
 - start.tv_usec) / 1e6,

522 
ru
.
ru_utime
.
tv_£c
 +„u.ru_utime.
tv_u£c
 / 1e6,

523 
ru
.
ru_¡ime
.
tv_£c
 +„u.ru_¡ime.
tv_u£c
 / 1e6);

525 
	}
}

	@performance/s-tree/rbtree/rbtree.c

12 
	~<lšux/rbŒ“_augm’‹d.h
>

13 
	~<lšux/expÜt.h
>

59 
šlše
 
	$rb_£t_bÏck
(
rb_node
 *
rb
)

61 
rb
->
__rb_·»Á_cŞÜ
 +ğ
RB_BLACK
;

62 
	}
}

64 
šlše
 
rb_node
 *
	$rb_»d_·»Á
(
rb_node
 *
»d
)

66  (
rb_node
 *)
»d
->
__rb_·»Á_cŞÜ
;

67 
	}
}

74 
šlše
 

75 
	$__rb_rÙ©e_£t_·»Ás
(
rb_node
 *
Şd
, rb_nod*
Ãw
,

76 
rb_roÙ
 *
roÙ
, 
cŞÜ
)

78 
rb_node
 *
·»Á
 = 
	`rb_·»Á
(
Şd
);

79 
Ãw
->
__rb_·»Á_cŞÜ
 = 
Şd
->__rb_parent_color;

80 
	`rb_£t_·»Á_cŞÜ
(
Şd
, 
Ãw
, 
cŞÜ
);

81 
	`__rb_chªge_chd
(
Şd
, 
Ãw
, 
·»Á
, 
roÙ
);

82 
	}
}

84 
__®ways_šlše
 

85 
__rb_š£¹
(
rb_node
 *
node
, 
rb_roÙ
 *
roÙ
,

86 (*
augm’t_rÙ©e
)(
rb_node
 *
Şd
, rb_nod*
Ãw
))

88 
rb_node
 *
·»Á
 = 
	`rb_»d_·»Á
(
node
), *
g·»Á
, *
tmp
;

90 
Œue
) {

94 ià(
	`uÆik–y
(!
·»Á
)) {

100 
	`rb_£t_·»Á_cŞÜ
(
node
, 
NULL
, 
RB_BLACK
);

110 if(
	`rb_is_bÏck
(
·»Á
))

113 
g·»Á
 = 
	`rb_»d_·»Á
(
·»Á
);

115 
tmp
 = 
g·»Á
->
rb_right
;

116 ià(
·»Á
 !ğ
tmp
) {

117 ià(
tmp
 && 
	`rb_is_»d
(tmp)) {

131 
	`rb_£t_·»Á_cŞÜ
(
tmp
, 
g·»Á
, 
RB_BLACK
);

132 
	`rb_£t_·»Á_cŞÜ
(
·»Á
, 
g·»Á
, 
RB_BLACK
);

133 
node
 = 
g·»Á
;

134 
·»Á
 = 
	`rb_·»Á
(
node
);

135 
	`rb_£t_·»Á_cŞÜ
(
node
, 
·»Á
, 
RB_RED
);

139 
tmp
 = 
·»Á
->
rb_right
;

140 ià(
node
 =ğ
tmp
) {

154 
tmp
 = 
node
->
rb_Ëá
;

155 
	`WRITE_ONCE
(
·»Á
->
rb_right
, 
tmp
);

156 
	`WRITE_ONCE
(
node
->
rb_Ëá
, 
·»Á
);

157 ià(
tmp
)

158 
	`rb_£t_·»Á_cŞÜ
(
tmp
, 
·»Á
,

159 
RB_BLACK
);

160 
	`rb_£t_·»Á_cŞÜ
(
·»Á
, 
node
, 
RB_RED
);

161 
	`augm’t_rÙ©e
(
·»Á
, 
node
);

162 
·»Á
 = 
node
;

163 
tmp
 = 
node
->
rb_right
;

176 
	`WRITE_ONCE
(
g·»Á
->
rb_Ëá
, 
tmp
);

177 
	`WRITE_ONCE
(
·»Á
->
rb_right
, 
g·»Á
);

178 ià(
tmp
)

179 
	`rb_£t_·»Á_cŞÜ
(
tmp
, 
g·»Á
, 
RB_BLACK
);

180 
	`__rb_rÙ©e_£t_·»Ás
(
g·»Á
, 
·»Á
, 
roÙ
, 
RB_RED
);

181 
	`augm’t_rÙ©e
(
g·»Á
, 
·»Á
);

184 
tmp
 = 
g·»Á
->
rb_Ëá
;

185 ià(
tmp
 && 
	`rb_is_»d
(tmp)) {

187 
	`rb_£t_·»Á_cŞÜ
(
tmp
, 
g·»Á
, 
RB_BLACK
);

188 
	`rb_£t_·»Á_cŞÜ
(
·»Á
, 
g·»Á
, 
RB_BLACK
);

189 
node
 = 
g·»Á
;

190 
·»Á
 = 
	`rb_·»Á
(
node
);

191 
	`rb_£t_·»Á_cŞÜ
(
node
, 
·»Á
, 
RB_RED
);

195 
tmp
 = 
·»Á
->
rb_Ëá
;

196 ià(
node
 =ğ
tmp
) {

198 
tmp
 = 
node
->
rb_right
;

199 
	`WRITE_ONCE
(
·»Á
->
rb_Ëá
, 
tmp
);

200 
	`WRITE_ONCE
(
node
->
rb_right
, 
·»Á
);

201 ià(
tmp
)

202 
	`rb_£t_·»Á_cŞÜ
(
tmp
, 
·»Á
,

203 
RB_BLACK
);

204 
	`rb_£t_·»Á_cŞÜ
(
·»Á
, 
node
, 
RB_RED
);

205 
	`augm’t_rÙ©e
(
·»Á
, 
node
);

206 
·»Á
 = 
node
;

207 
tmp
 = 
node
->
rb_Ëá
;

211 
	`WRITE_ONCE
(
g·»Á
->
rb_right
, 
tmp
);

212 
	`WRITE_ONCE
(
·»Á
->
rb_Ëá
, 
g·»Á
);

213 ià(
tmp
)

214 
	`rb_£t_·»Á_cŞÜ
(
tmp
, 
g·»Á
, 
RB_BLACK
);

215 
	`__rb_rÙ©e_£t_·»Ás
(
g·»Á
, 
·»Á
, 
roÙ
, 
RB_RED
);

216 
	`augm’t_rÙ©e
(
g·»Á
, 
·»Á
);

220 
	}
}

226 
__®ways_šlše
 

227 
____rb_”a£_cŞÜ
(
rb_node
 *
·»Á
, 
rb_roÙ
 *
roÙ
,

228 (*
augm’t_rÙ©e
)(
rb_node
 *
Şd
, rb_nod*
Ãw
))

230 
rb_node
 *
node
 = 
NULL
, *
siblšg
, *
tmp1
, *
tmp2
;

232 
Œue
) {

240 
siblšg
 = 
·»Á
->
rb_right
;

241 ià(
node
 !ğ
siblšg
) {

242 ià(
	`rb_is_»d
(
siblšg
)) {

252 
tmp1
 = 
siblšg
->
rb_Ëá
;

253 
	`WRITE_ONCE
(
·»Á
->
rb_right
, 
tmp1
);

254 
	`WRITE_ONCE
(
siblšg
->
rb_Ëá
, 
·»Á
);

255 
	`rb_£t_·»Á_cŞÜ
(
tmp1
, 
·»Á
, 
RB_BLACK
);

256 
	`__rb_rÙ©e_£t_·»Ás
(
·»Á
, 
siblšg
, 
roÙ
,

257 
RB_RED
);

258 
	`augm’t_rÙ©e
(
·»Á
, 
siblšg
);

259 
siblšg
 = 
tmp1
;

261 
tmp1
 = 
siblšg
->
rb_right
;

262 ià(!
tmp1
 || 
	`rb_is_bÏck
(tmp1)) {

263 
tmp2
 = 
siblšg
->
rb_Ëá
;

264 ià(!
tmp2
 || 
	`rb_is_bÏck
(tmp2)) {

280 
	`rb_£t_·»Á_cŞÜ
(
siblšg
, 
·»Á
,

281 
RB_RED
);

282 ià(
	`rb_is_»d
(
·»Á
))

283 
	`rb_£t_bÏck
(
·»Á
);

285 
node
 = 
·»Á
;

286 
·»Á
 = 
	`rb_·»Á
(
node
);

287 ià(
·»Á
)

319 
tmp1
 = 
tmp2
->
rb_right
;

320 
	`WRITE_ONCE
(
siblšg
->
rb_Ëá
, 
tmp1
);

321 
	`WRITE_ONCE
(
tmp2
->
rb_right
, 
siblšg
);

322 
	`WRITE_ONCE
(
·»Á
->
rb_right
, 
tmp2
);

323 ià(
tmp1
)

324 
	`rb_£t_·»Á_cŞÜ
(
tmp1
, 
siblšg
,

325 
RB_BLACK
);

326 
	`augm’t_rÙ©e
(
siblšg
, 
tmp2
);

327 
tmp1
 = 
siblšg
;

328 
siblšg
 = 
tmp2
;

342 
tmp2
 = 
siblšg
->
rb_Ëá
;

343 
	`WRITE_ONCE
(
·»Á
->
rb_right
, 
tmp2
);

344 
	`WRITE_ONCE
(
siblšg
->
rb_Ëá
, 
·»Á
);

345 
	`rb_£t_·»Á_cŞÜ
(
tmp1
, 
siblšg
, 
RB_BLACK
);

346 ià(
tmp2
)

347 
	`rb_£t_·»Á
(
tmp2
, 
·»Á
);

348 
	`__rb_rÙ©e_£t_·»Ás
(
·»Á
, 
siblšg
, 
roÙ
,

349 
RB_BLACK
);

350 
	`augm’t_rÙ©e
(
·»Á
, 
siblšg
);

353 
siblšg
 = 
·»Á
->
rb_Ëá
;

354 ià(
	`rb_is_»d
(
siblšg
)) {

356 
tmp1
 = 
siblšg
->
rb_right
;

357 
	`WRITE_ONCE
(
·»Á
->
rb_Ëá
, 
tmp1
);

358 
	`WRITE_ONCE
(
siblšg
->
rb_right
, 
·»Á
);

359 
	`rb_£t_·»Á_cŞÜ
(
tmp1
, 
·»Á
, 
RB_BLACK
);

360 
	`__rb_rÙ©e_£t_·»Ás
(
·»Á
, 
siblšg
, 
roÙ
,

361 
RB_RED
);

362 
	`augm’t_rÙ©e
(
·»Á
, 
siblšg
);

363 
siblšg
 = 
tmp1
;

365 
tmp1
 = 
siblšg
->
rb_Ëá
;

366 ià(!
tmp1
 || 
	`rb_is_bÏck
(tmp1)) {

367 
tmp2
 = 
siblšg
->
rb_right
;

368 ià(!
tmp2
 || 
	`rb_is_bÏck
(tmp2)) {

370 
	`rb_£t_·»Á_cŞÜ
(
siblšg
, 
·»Á
,

371 
RB_RED
);

372 ià(
	`rb_is_»d
(
·»Á
))

373 
	`rb_£t_bÏck
(
·»Á
);

375 
node
 = 
·»Á
;

376 
·»Á
 = 
	`rb_·»Á
(
node
);

377 ià(
·»Á
)

383 
tmp1
 = 
tmp2
->
rb_Ëá
;

384 
	`WRITE_ONCE
(
siblšg
->
rb_right
, 
tmp1
);

385 
	`WRITE_ONCE
(
tmp2
->
rb_Ëá
, 
siblšg
);

386 
	`WRITE_ONCE
(
·»Á
->
rb_Ëá
, 
tmp2
);

387 ià(
tmp1
)

388 
	`rb_£t_·»Á_cŞÜ
(
tmp1
, 
siblšg
,

389 
RB_BLACK
);

390 
	`augm’t_rÙ©e
(
siblšg
, 
tmp2
);

391 
tmp1
 = 
siblšg
;

392 
siblšg
 = 
tmp2
;

395 
tmp2
 = 
siblšg
->
rb_right
;

396 
	`WRITE_ONCE
(
·»Á
->
rb_Ëá
, 
tmp2
);

397 
	`WRITE_ONCE
(
siblšg
->
rb_right
, 
·»Á
);

398 
	`rb_£t_·»Á_cŞÜ
(
tmp1
, 
siblšg
, 
RB_BLACK
);

399 ià(
tmp2
)

400 
	`rb_£t_·»Á
(
tmp2
, 
·»Á
);

401 
	`__rb_rÙ©e_£t_·»Ás
(
·»Á
, 
siblšg
, 
roÙ
,

402 
RB_BLACK
);

403 
	`augm’t_rÙ©e
(
·»Á
, 
siblšg
);

407 
	}
}

410 
__rb_”a£_cŞÜ
(
rb_node
 *
·»Á
, 
rb_roÙ
 *
roÙ
,

411 (*
augm’t_rÙ©e
)(
rb_node
 *
Şd
, rb_nod*
Ãw
))

413 
	`____rb_”a£_cŞÜ
(
·»Á
, 
roÙ
, 
augm’t_rÙ©e
);

414 
	}
}

415 
EXPORT_SYMBOL
(
__rb_”a£_cŞÜ
);

424 
šlše
 
	$dummy_´İag©e
(
rb_node
 *
node
, rb_nod*
¡İ
è{
	}
}

425 
šlše
 
	$dummy_cİy
(
rb_node
 *
Şd
, rb_nod*
Ãw
è{
	}
}

426 
šlše
 
	$dummy_rÙ©e
(
rb_node
 *
Şd
, rb_nod*
Ãw
è{
	}
}

428 cÚ¡ 
rb_augm’t_ÿÎbacks
 
	gdummy_ÿÎbacks
 = {

429 .
´İag©e
 = 
dummy_´İag©e
,

430 .
	gcİy
 = 
dummy_cİy
,

431 .
	grÙ©e
 = 
dummy_rÙ©e


434 
	$rb_š£¹_cŞÜ
(
rb_node
 *
node
, 
rb_roÙ
 *
roÙ
)

436 
	`__rb_š£¹
(
node
, 
roÙ
, 
dummy_rÙ©e
);

437 
	}
}

438 
EXPORT_SYMBOL
(
rb_š£¹_cŞÜ
);

440 
	$rb_”a£
(
rb_node
 *
node
, 
rb_roÙ
 *
roÙ
)

442 
rb_node
 *
»b®ªû
;

443 
»b®ªû
 = 
	`__rb_”a£_augm’‹d
(
node
, 
roÙ
, &
dummy_ÿÎbacks
);

444 ià(
»b®ªû
)

445 
	`____rb_”a£_cŞÜ
(
»b®ªû
, 
roÙ
, 
dummy_rÙ©e
);

446 
	}
}

447 
EXPORT_SYMBOL
(
rb_”a£
);

456 
__rb_š£¹_augm’‹d
(
rb_node
 *
node
, 
rb_roÙ
 *
roÙ
,

457 (*
augm’t_rÙ©e
)(
rb_node
 *
Şd
, rb_nod*
Ãw
))

459 
	`__rb_š£¹
(
node
, 
roÙ
, 
augm’t_rÙ©e
);

460 
	}
}

461 
EXPORT_SYMBOL
(
__rb_š£¹_augm’‹d
);

466 
rb_node
 *
	$rb_fœ¡
(cÚ¡ 
rb_roÙ
 *
roÙ
)

468 
rb_node
 *
n
;

470 
n
 = 
roÙ
->
rb_node
;

471 ià(!
n
)

472  
NULL
;

473 
n
->
rb_Ëá
)

474 
n
 =‚->
rb_Ëá
;

475  
n
;

476 
	}
}

477 
EXPORT_SYMBOL
(
rb_fœ¡
);

479 
rb_node
 *
	$rb_Ï¡
(cÚ¡ 
rb_roÙ
 *
roÙ
)

481 
rb_node
 *
n
;

483 
n
 = 
roÙ
->
rb_node
;

484 ià(!
n
)

485  
NULL
;

486 
n
->
rb_right
)

487 
n
 =‚->
rb_right
;

488  
n
;

489 
	}
}

490 
EXPORT_SYMBOL
(
rb_Ï¡
);

492 
rb_node
 *
	$rb_Ãxt
(cÚ¡ 
rb_node
 *
node
)

494 
rb_node
 *
·»Á
;

496 ià(
	`RB_EMPTY_NODE
(
node
))

497  
NULL
;

503 ià(
node
->
rb_right
) {

504 
node
 =‚ode->
rb_right
;

505 
node
->
rb_Ëá
)

506 
node
 =‚ode->
rb_Ëá
;

507  (
rb_node
 *)
node
;

517 (
·»Á
 = 
	`rb_·»Á
(
node
)è&&‚od=ğ·»Á->
rb_right
)

518 
node
 = 
·»Á
;

520  
·»Á
;

521 
	}
}

522 
EXPORT_SYMBOL
(
rb_Ãxt
);

524 
rb_node
 *
	$rb_´ev
(cÚ¡ 
rb_node
 *
node
)

526 
rb_node
 *
·»Á
;

528 ià(
	`RB_EMPTY_NODE
(
node
))

529  
NULL
;

535 ià(
node
->
rb_Ëá
) {

536 
node
 =‚ode->
rb_Ëá
;

537 
node
->
rb_right
)

538 
node
 =‚ode->
rb_right
;

539  (
rb_node
 *)
node
;

546 (
·»Á
 = 
	`rb_·»Á
(
node
)è&&‚od=ğ·»Á->
rb_Ëá
)

547 
node
 = 
·»Á
;

549  
·»Á
;

550 
	}
}

551 
EXPORT_SYMBOL
(
rb_´ev
);

553 
	$rb_»¶aû_node
(
rb_node
 *
viùim
, rb_nod*
Ãw
,

554 
rb_roÙ
 *
roÙ
)

556 
rb_node
 *
·»Á
 = 
	`rb_·»Á
(
viùim
);

559 *
Ãw
 = *
viùim
;

562 ià(
viùim
->
rb_Ëá
)

563 
	`rb_£t_·»Á
(
viùim
->
rb_Ëá
, 
Ãw
);

564 ià(
viùim
->
rb_right
)

565 
	`rb_£t_·»Á
(
viùim
->
rb_right
, 
Ãw
);

566 
	`__rb_chªge_chd
(
viùim
, 
Ãw
, 
·»Á
, 
roÙ
);

567 
	}
}

568 
EXPORT_SYMBOL
(
rb_»¶aû_node
);

570 
	$rb_»¶aû_node_rcu
(
rb_node
 *
viùim
, rb_nod*
Ãw
,

571 
rb_roÙ
 *
roÙ
)

573 
rb_node
 *
·»Á
 = 
	`rb_·»Á
(
viùim
);

576 *
Ãw
 = *
viùim
;

579 ià(
viùim
->
rb_Ëá
)

580 
	`rb_£t_·»Á
(
viùim
->
rb_Ëá
, 
Ãw
);

581 ià(
viùim
->
rb_right
)

582 
	`rb_£t_·»Á
(
viùim
->
rb_right
, 
Ãw
);

588 
	`__rb_chªge_chd_rcu
(
viùim
, 
Ãw
, 
·»Á
, 
roÙ
);

589 
	}
}

590 
EXPORT_SYMBOL
(
rb_»¶aû_node_rcu
);

592 
rb_node
 *
	$rb_Ëá_d“³¡_node
(cÚ¡ 
rb_node
 *
node
)

595 ià(
node
->
rb_Ëá
)

596 
node
 =‚ode->
rb_Ëá
;

597 ià(
node
->
rb_right
)

598 
node
 =‚ode->
rb_right
;

600  (
rb_node
 *)
node
;

602 
	}
}

604 
rb_node
 *
	$rb_Ãxt_po¡Üd”
(cÚ¡ 
rb_node
 *
node
)

606 cÚ¡ 
rb_node
 *
·»Á
;

607 ià(!
node
)

608  
NULL
;

609 
·»Á
 = 
	`rb_·»Á
(
node
);

612 ià(
·»Á
 && 
node
 =ğ·»Á->
rb_Ëá
 &&…¬’t->
rb_right
) {

615  
	`rb_Ëá_d“³¡_node
(
·»Á
->
rb_right
);

619  (
rb_node
 *)
·»Á
;

620 
	}
}

621 
EXPORT_SYMBOL
(
rb_Ãxt_po¡Üd”
);

623 
rb_node
 *
	$rb_fœ¡_po¡Üd”
(cÚ¡ 
rb_roÙ
 *
roÙ
)

625 ià(!
roÙ
->
rb_node
)

626  
NULL
;

628  
	`rb_Ëá_d“³¡_node
(
roÙ
->
rb_node
);

629 
	}
}

630 
EXPORT_SYMBOL
(
rb_fœ¡_po¡Üd”
);

	@performance/s-tree/rbtree/rbtree.h

1 #iâdeà
__TOOLS_LINUX_PERF_RBTREE_H


2 
	#__TOOLS_LINUX_PERF_RBTREE_H


	)

4 
	~<lšux/k”Ãl.h
>

5 
	~<lšux/¡ddef.h
>

7 
	srb_node
 {

8 
	m__rb_·»Á_cŞÜ
;

9 
rb_node
 *
	mrb_right
;

10 
rb_node
 *
	mrb_Ëá
;

11 } 
__©Œibu‹__
((
®igÃd
(())));

14 
	srb_roÙ
 {

15 
rb_node
 *
	mrb_node
;

18 
	#rb_·»Á
(
r
è((
rb_node
 *)(Ô)->
__rb_·»Á_cŞÜ
 & ~3))

	)

20 
	#RB_ROOT
 (
rb_roÙ
è{ 
NULL
, }

	)

21 
	#rb_’Œy
(
±r
, 
ty³
, 
memb”
è
	`cÚš”_of
ÕŒ,y³, memb”)

	)

23 
	#RB_EMPTY_ROOT
(
roÙ
è(
	`READ_ONCE
(ÔoÙ)->
rb_node
è=ğ
NULL
)

	)

26 
	#RB_EMPTY_NODE
(
node
) \

27 ((
node
)->
__rb_·»Á_cŞÜ
 =ğ()Òode))

	)

28 
	#RB_CLEAR_NODE
(
node
) \

29 ((
node
)->
__rb_·»Á_cŞÜ
 = ()Òode))

	)

32 
rb_š£¹_cŞÜ
(
rb_node
 *, 
rb_roÙ
 *);

33 
rb_”a£
(
rb_node
 *, 
rb_roÙ
 *);

37 
rb_node
 *
rb_Ãxt
(const rb_node *);

38 
rb_node
 *
rb_´ev
(const rb_node *);

39 
rb_node
 *
rb_fœ¡
(cÚ¡ 
rb_roÙ
 *);

40 
rb_node
 *
rb_Ï¡
(cÚ¡ 
rb_roÙ
 *);

43 
rb_node
 *
rb_fœ¡_po¡Üd”
(cÚ¡ 
rb_roÙ
 *);

44 
rb_node
 *
rb_Ãxt_po¡Üd”
(const rb_node *);

47 
rb_»¶aû_node
(
rb_node
 *
viùim
, rb_nod*
Ãw
,

48 
rb_roÙ
 *
roÙ
);

50 
šlše
 
	$rb_lšk_node
(
rb_node
 *
node
, rb_nod*
·»Á
,

51 
rb_node
 **
rb_lšk
)

53 
node
->
__rb_·»Á_cŞÜ
 = ()
·»Á
;

54 
node
->
rb_Ëá
 =‚ode->
rb_right
 = 
NULL
;

56 *
rb_lšk
 = 
node
;

57 
	}
}

59 
	#rb_’Œy_§ã
(
±r
, 
ty³
, 
memb”
) \

60 ({ 
	`ty³of
(
±r
è
____±r
 = (ptr); \

61 
____±r
 ? 
	`rb_’Œy
(____±r, 
ty³
, 
memb”
è: 
NULL
; \

62 })

	)

81 
	#rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
pos
, 
n
, 
roÙ
, 
f›ld
) \

82 
pos
 = 
	`rb_’Œy_§ã
(
	`rb_fœ¡_po¡Üd”
(
roÙ
), 
	`ty³of
(*pos), 
f›ld
); \

83 
pos
 && ({ 
n
 = 
	`rb_’Œy_§ã
(
	`rb_Ãxt_po¡Üd”
(&pos->
f›ld
), \

84 
	`ty³of
(*
pos
), 
f›ld
); 1; }); \

85 
pos
 = 
n
)

	)

87 
šlše
 
	$rb_”a£_š™
(
rb_node
 *
n
, 
rb_roÙ
 *
roÙ
)

89 
	`rb_”a£
(
n
, 
roÙ
);

90 
	`RB_CLEAR_NODE
(
n
);

91 
	}
}

103 
	srb_roÙ_ÿched
 {

104 
rb_roÙ
 
	mrb_roÙ
;

105 
rb_node
 *
	mrb_Ëámo¡
;

108 
	#RB_ROOT_CACHED
 (
rb_roÙ_ÿched
è{ {
NULL
, }, NULL }

	)

111 
	#rb_fœ¡_ÿched
(
roÙ
èÔoÙ)->
rb_Ëámo¡


	)

113 
šlše
 
	$rb_š£¹_cŞÜ_ÿched
(
rb_node
 *
node
,

114 
rb_roÙ_ÿched
 *
roÙ
,

115 
boŞ
 
Ëámo¡
)

117 ià(
Ëámo¡
)

118 
roÙ
->
rb_Ëámo¡
 = 
node
;

119 
	`rb_š£¹_cŞÜ
(
node
, &
roÙ
->
rb_roÙ
);

120 
	}
}

122 
šlše
 
	$rb_”a£_ÿched
(
rb_node
 *
node
,

123 
rb_roÙ_ÿched
 *
roÙ
)

125 ià(
roÙ
->
rb_Ëámo¡
 =ğ
node
)

126 
roÙ
->
rb_Ëámo¡
 = 
	`rb_Ãxt
(
node
);

127 
	`rb_”a£
(
node
, &
roÙ
->
rb_roÙ
);

128 
	}
}

130 
šlše
 
	$rb_»¶aû_node_ÿched
(
rb_node
 *
viùim
,

131 
rb_node
 *
Ãw
,

132 
rb_roÙ_ÿched
 *
roÙ
)

134 ià(
roÙ
->
rb_Ëámo¡
 =ğ
viùim
)

135 
roÙ
->
rb_Ëámo¡
 = 
Ãw
;

136 
	`rb_»¶aû_node
(
viùim
, 
Ãw
, &
roÙ
->
rb_roÙ
);

137 
	}
}

161 
__®ways_šlše
 

162 
rb_add_ÿched
(
rb_node
 *
node
, 
rb_roÙ_ÿched
 *
Œ“
,

163 
	$boŞ
 (*
Ëss
)(
rb_node
 *, const rb_node *))

165 
rb_node
 **
lšk
 = &
Œ“
->
rb_roÙ
.rb_node;

166 
rb_node
 *
·»Á
 = 
NULL
;

167 
boŞ
 
Ëámo¡
 = 
Œue
;

169 *
lšk
) {

170 
·»Á
 = *
lšk
;

171 ià(
	`Ëss
(
node
, 
·»Á
)) {

172 
lšk
 = &
·»Á
->
rb_Ëá
;

174 
lšk
 = &
·»Á
->
rb_right
;

175 
Ëámo¡
 = 
çl£
;

179 
	`rb_lšk_node
(
node
, 
·»Á
, 
lšk
);

180 
	`rb_š£¹_cŞÜ_ÿched
(
node
, 
Œ“
, 
Ëámo¡
);

181 
	}
}

189 
__®ways_šlše
 

190 
rb_add
(
rb_node
 *
node
, 
rb_roÙ
 *
Œ“
,

191 
	$boŞ
 (*
Ëss
)(
rb_node
 *, const rb_node *))

193 
rb_node
 **
lšk
 = &
Œ“
->rb_node;

194 
rb_node
 *
·»Á
 = 
NULL
;

196 *
lšk
) {

197 
·»Á
 = *
lšk
;

198 ià(
	`Ëss
(
node
, 
·»Á
))

199 
lšk
 = &
·»Á
->
rb_Ëá
;

201 
lšk
 = &
·»Á
->
rb_right
;

204 
	`rb_lšk_node
(
node
, 
·»Á
, 
lšk
);

205 
	`rb_š£¹_cŞÜ
(
node
, 
Œ“
);

206 
	}
}

217 
__®ways_šlše
 
rb_node
 *

218 
rb_fšd_add
(
rb_node
 *
node
, 
rb_roÙ
 *
Œ“
,

219 (*
cmp
)(
rb_node
 *, const rb_node *))

221 
rb_node
 **
lšk
 = &
Œ“
->rb_node;

222 
rb_node
 *
·»Á
 = 
NULL
;

223 
c
;

225 *
lšk
) {

226 
·»Á
 = *
lšk
;

227 
c
 = 
	`cmp
(
node
, 
·»Á
);

229 ià(
c
 < 0)

230 
lšk
 = &
·»Á
->
rb_Ëá
;

231 ià(
c
 > 0)

232 
lšk
 = &
·»Á
->
rb_right
;

234  
·»Á
;

237 
	`rb_lšk_node
(
node
, 
·»Á
, 
lšk
);

238 
	`rb_š£¹_cŞÜ
(
node
, 
Œ“
);

239  
NULL
;

240 
	}
}

250 
__®ways_šlše
 
rb_node
 *

251 
rb_fšd
(cÚ¡ *
key
, cÚ¡ 
rb_roÙ
 *
Œ“
,

252 (*
cmp
)(cÚ¡ *
key
, cÚ¡ 
rb_node
 *))

254 
rb_node
 *
node
 = 
Œ“
->rb_node;

256 
node
) {

257 
c
 = 
	`cmp
(
key
, 
node
);

259 ià(
c
 < 0)

260 
node
 =‚ode->
rb_Ëá
;

261 ià(
c
 > 0)

262 
node
 =‚ode->
rb_right
;

264  
node
;

267  
NULL
;

268 
	}
}

278 
__®ways_šlše
 
rb_node
 *

279 
rb_fšd_fœ¡
(cÚ¡ *
key
, cÚ¡ 
rb_roÙ
 *
Œ“
,

280 (*
cmp
)(cÚ¡ *
key
, cÚ¡ 
rb_node
 *))

282 
rb_node
 *
node
 = 
Œ“
->rb_node;

283 
rb_node
 *
m©ch
 = 
NULL
;

285 
node
) {

286 
c
 = 
	`cmp
(
key
, 
node
);

288 ià(
c
 <= 0) {

289 ià(!
c
)

290 
m©ch
 = 
node
;

291 
node
 =‚ode->
rb_Ëá
;

292 } ià(
c
 > 0) {

293 
node
 =‚ode->
rb_right
;

297  
m©ch
;

298 
	}
}

308 
__®ways_šlše
 
rb_node
 *

309 
rb_Ãxt_m©ch
(cÚ¡ *
key
, 
rb_node
 *
node
,

310 (*
cmp
)(cÚ¡ *
key
, cÚ¡ 
rb_node
 *))

312 
node
 = 
	`rb_Ãxt
(node);

313 ià(
node
 && 
	`cmp
(
key
,‚ode))

314 
node
 = 
NULL
;

315  
node
;

316 
	}
}

325 
	#rb_fÜ_—ch
(
node
, 
key
, 
Œ“
, 
cmp
) \

326 (
node
èğ
	`rb_fšd_fœ¡
((
key
), (
Œ“
), (
cmp
)); \

327 (
node
); (nodeèğ
	`rb_Ãxt_m©ch
((
key
), (node), (
cmp
)))

	)

	@performance/s-tree/rbtree/rbtree_augmented.h

12 #iâdeà
_LINUX_RBTREE_AUGMENTED_H


13 
	#_LINUX_RBTREE_AUGMENTED_H


	)

15 
	~<lšux/comp”.h
>

16 
	~<lšux/rbŒ“.h
>

17 
	~<lšux/rcupd©e.h
>

27 
	srb_augm’t_ÿÎbacks
 {

28 (*
	m´İag©e
)(
rb_node
 *
	mnode
, rb_nod*
	m¡İ
);

29 (*
	mcİy
)(
rb_node
 *
	mŞd
, rb_nod*
	mÃw
);

30 (*
	mrÙ©e
)(
rb_node
 *
	mŞd
, rb_nod*
	mÃw
);

33 
__rb_š£¹_augm’‹d
(
rb_node
 *
node
, 
rb_roÙ
 *
roÙ
,

34 (*
augm’t_rÙ©e
)(
rb_node
 *
Şd
, rb_nod*
Ãw
));

46 
šlše
 

47 
	$rb_š£¹_augm’‹d
(
rb_node
 *
node
, 
rb_roÙ
 *
roÙ
,

48 cÚ¡ 
rb_augm’t_ÿÎbacks
 *
augm’t
)

50 
	`__rb_š£¹_augm’‹d
(
node
, 
roÙ
, 
augm’t
->
rÙ©e
);

51 
	}
}

53 
šlše
 

54 
	$rb_š£¹_augm’‹d_ÿched
(
rb_node
 *
node
,

55 
rb_roÙ_ÿched
 *
roÙ
, 
boŞ
 
ÃwËá
,

56 cÚ¡ 
rb_augm’t_ÿÎbacks
 *
augm’t
)

58 ià(
ÃwËá
)

59 
roÙ
->
rb_Ëámo¡
 = 
node
;

60 
	`rb_š£¹_augm’‹d
(
node
, &
roÙ
->
rb_roÙ
, 
augm’t
);

61 
	}
}

74 
	#RB_DECLARE_CALLBACKS
(
RBSTATIC
, 
RBNAME
, \

75 
RBSTRUCT
, 
RBFIELD
, 
RBAUGMENTED
, 
RBCOMPUTE
) \

76 
šlše
 \

77 
RBNAME
 ## 
	`_´İag©e
(
rb_node
 *
rb
, rb_nod*
¡İ
) \

79 
rb
 !ğ
¡İ
) { \

80 
RBSTRUCT
 *
node
 = 
	`rb_’Œy
(
rb
, RBSTRUCT, 
RBFIELD
); \

81 ià(
	`RBCOMPUTE
(
node
, 
Œue
)) \

83 
rb
 = 
	`rb_·»Á
(&
node
->
RBFIELD
); \

86 
šlše
 \

87 
RBNAME
 ## 
	`_cİy
(
rb_node
 *
rb_Şd
, rb_nod*
rb_Ãw
) \

89 
RBSTRUCT
 *
Şd
 = 
	`rb_’Œy
(
rb_Şd
, RBSTRUCT, 
RBFIELD
); \

90 
RBSTRUCT
 *
Ãw
 = 
	`rb_’Œy
(
rb_Ãw
, RBSTRUCT, 
RBFIELD
); \

91 
Ãw
->
RBAUGMENTED
 = 
Şd
->RBAUGMENTED; \

94 
RBNAME
 ## 
	`_rÙ©e
(
rb_node
 *
rb_Şd
, rb_nod*
rb_Ãw
) \

96 
RBSTRUCT
 *
Şd
 = 
	`rb_’Œy
(
rb_Şd
, RBSTRUCT, 
RBFIELD
); \

97 
RBSTRUCT
 *
Ãw
 = 
	`rb_’Œy
(
rb_Ãw
, RBSTRUCT, 
RBFIELD
); \

98 
Ãw
->
RBAUGMENTED
 = 
Şd
->RBAUGMENTED; \

99 
	`RBCOMPUTE
(
Şd
, 
çl£
); \

101 
RBSTATIC
 cÚ¡ 
rb_augm’t_ÿÎbacks
 
RBNAME
 = { \

102 .
´İag©e
 = 
RBNAME
 ## 
_´İag©e
, \

103 .
cİy
 = 
RBNAME
 ## 
_cİy
, \

104 .
rÙ©e
 = 
RBNAME
 ## 
_rÙ©e
 \

105 };

	)

120 
	#RB_DECLARE_CALLBACKS_MAX
(
RBSTATIC
, 
RBNAME
, 
RBSTRUCT
, 
RBFIELD
, \

121 
RBTYPE
, 
RBAUGMENTED
, 
RBCOMPUTE
) \

122 
šlše
 
boŞ
 
RBNAME
 ## 
	`_compu‹_max
(
RBSTRUCT
 *
node
, boŞ 
ex™
) \

124 
RBSTRUCT
 *
chd
; \

125 
RBTYPE
 
max
 = 
	`RBCOMPUTE
(
node
); \

126 ià(
node
->
RBFIELD
.
rb_Ëá
) { \

127 
chd
 = 
	`rb_’Œy
(
node
->
RBFIELD
.
rb_Ëá
, 
RBSTRUCT
, RBFIELD); \

128 ià(
chd
->
RBAUGMENTED
 > 
max
) \

129 
max
 = 
chd
->
RBAUGMENTED
; \

131 ià(
node
->
RBFIELD
.
rb_right
) { \

132 
chd
 = 
	`rb_’Œy
(
node
->
RBFIELD
.
rb_right
, 
RBSTRUCT
, RBFIELD); \

133 ià(
chd
->
RBAUGMENTED
 > 
max
) \

134 
max
 = 
chd
->
RBAUGMENTED
; \

136 ià(
ex™
 && 
node
->
RBAUGMENTED
 =ğ
max
) \

137  
Œue
; \

138 
node
->
RBAUGMENTED
 = 
max
; \

139  
çl£
; \

141 
	`RB_DECLARE_CALLBACKS
(
RBSTATIC
, 
RBNAME
, \

142 
RBSTRUCT
, 
RBFIELD
, 
RBAUGMENTED
, 
RBNAME
 ## 
_compu‹_max
)

	)

145 
	#RB_RED
 0

	)

146 
	#RB_BLACK
 1

	)

148 
	#__rb_·»Á
(
pc
è((
rb_node
 *)Õø& ~3))

	)

150 
	#__rb_cŞÜ
(
pc
è(Õcè& 1)

	)

151 
	#__rb_is_bÏck
(
pc
è
	`__rb_cŞÜ
Õc)

	)

152 
	#__rb_is_»d
(
pc
è(!
	`__rb_cŞÜ
Õc))

	)

153 
	#rb_cŞÜ
(
rb
è
	`__rb_cŞÜ
(Ôb)->
__rb_·»Á_cŞÜ
)

	)

154 
	#rb_is_»d
(
rb
è
	`__rb_is_»d
(Ôb)->
__rb_·»Á_cŞÜ
)

	)

155 
	#rb_is_bÏck
(
rb
è
	`__rb_is_bÏck
(Ôb)->
__rb_·»Á_cŞÜ
)

	)

157 
šlše
 
	$rb_£t_·»Á
(
rb_node
 *
rb
, rb_nod*
p
)

159 
rb
->
__rb_·»Á_cŞÜ
 = 
	`rb_cŞÜ
Ôbè+ ()
p
;

160 
	}
}

162 
šlše
 
	$rb_£t_·»Á_cŞÜ
(
rb_node
 *
rb
,

163 
rb_node
 *
p
, 
cŞÜ
)

165 
rb
->
__rb_·»Á_cŞÜ
 = ()
p
 + 
cŞÜ
;

166 
	}
}

168 
šlše
 

169 
	$__rb_chªge_chd
(
rb_node
 *
Şd
, rb_nod*
Ãw
,

170 
rb_node
 *
·»Á
, 
rb_roÙ
 *
roÙ
)

172 ià(
·»Á
) {

173 ià(
·»Á
->
rb_Ëá
 =ğ
Şd
)

174 
	`WRITE_ONCE
(
·»Á
->
rb_Ëá
, 
Ãw
);

176 
	`WRITE_ONCE
(
·»Á
->
rb_right
, 
Ãw
);

178 
	`WRITE_ONCE
(
roÙ
->
rb_node
, 
Ãw
);

179 
	}
}

181 
šlše
 

182 
	$__rb_chªge_chd_rcu
(
rb_node
 *
Şd
, rb_nod*
Ãw
,

183 
rb_node
 *
·»Á
, 
rb_roÙ
 *
roÙ
)

185 ià(
·»Á
) {

186 ià(
·»Á
->
rb_Ëá
 =ğ
Şd
)

187 
	`rcu_assign_poš‹r
(
·»Á
->
rb_Ëá
, 
Ãw
);

189 
	`rcu_assign_poš‹r
(
·»Á
->
rb_right
, 
Ãw
);

191 
	`rcu_assign_poš‹r
(
roÙ
->
rb_node
, 
Ãw
);

192 
	}
}

194 
__rb_”a£_cŞÜ
(
rb_node
 *
·»Á
, 
rb_roÙ
 *
roÙ
,

195 (*
augm’t_rÙ©e
)(
rb_node
 *
Şd
, rb_nod*
Ãw
));

197 
__®ways_šlše
 
rb_node
 *

198 
	$__rb_”a£_augm’‹d
(
rb_node
 *
node
, 
rb_roÙ
 *
roÙ
,

199 cÚ¡ 
rb_augm’t_ÿÎbacks
 *
augm’t
)

201 
rb_node
 *
chd
 = 
node
->
rb_right
;

202 
rb_node
 *
tmp
 = 
node
->
rb_Ëá
;

203 
rb_node
 *
·»Á
, *
»b®ªû
;

204 
pc
;

206 ià(!
tmp
) {

214 
pc
 = 
node
->
__rb_·»Á_cŞÜ
;

215 
·»Á
 = 
	`__rb_·»Á
(
pc
);

216 
	`__rb_chªge_chd
(
node
, 
chd
, 
·»Á
, 
roÙ
);

217 ià(
chd
) {

218 
chd
->
__rb_·»Á_cŞÜ
 = 
pc
;

219 
»b®ªû
 = 
NULL
;

221 
»b®ªû
 = 
	`__rb_is_bÏck
(
pc
è? 
·»Á
 : 
NULL
;

222 
tmp
 = 
·»Á
;

223 } ià(!
chd
) {

225 
tmp
->
__rb_·»Á_cŞÜ
 = 
pc
 = 
node
->__rb_parent_color;

226 
·»Á
 = 
	`__rb_·»Á
(
pc
);

227 
	`__rb_chªge_chd
(
node
, 
tmp
, 
·»Á
, 
roÙ
);

228 
»b®ªû
 = 
NULL
;

229 
tmp
 = 
·»Á
;

231 
rb_node
 *
sucûssÜ
 = 
chd
, *
chd2
;

233 
tmp
 = 
chd
->
rb_Ëá
;

234 ià(!
tmp
) {

244 
·»Á
 = 
sucûssÜ
;

245 
chd2
 = 
sucûssÜ
->
rb_right
;

247 
augm’t
->
	`cİy
(
node
, 
sucûssÜ
);

264 
·»Á
 = 
sucûssÜ
;

265 
sucûssÜ
 = 
tmp
;

266 
tmp
 =mp->
rb_Ëá
;

267 } 
tmp
);

268 
chd2
 = 
sucûssÜ
->
rb_right
;

269 
	`WRITE_ONCE
(
·»Á
->
rb_Ëá
, 
chd2
);

270 
	`WRITE_ONCE
(
sucûssÜ
->
rb_right
, 
chd
);

271 
	`rb_£t_·»Á
(
chd
, 
sucûssÜ
);

273 
augm’t
->
	`cİy
(
node
, 
sucûssÜ
);

274 
augm’t
->
	`´İag©e
(
·»Á
, 
sucûssÜ
);

277 
tmp
 = 
node
->
rb_Ëá
;

278 
	`WRITE_ONCE
(
sucûssÜ
->
rb_Ëá
, 
tmp
);

279 
	`rb_£t_·»Á
(
tmp
, 
sucûssÜ
);

281 
pc
 = 
node
->
__rb_·»Á_cŞÜ
;

282 
tmp
 = 
	`__rb_·»Á
(
pc
);

283 
	`__rb_chªge_chd
(
node
, 
sucûssÜ
, 
tmp
, 
roÙ
);

285 ià(
chd2
) {

286 
	`rb_£t_·»Á_cŞÜ
(
chd2
, 
·»Á
, 
RB_BLACK
);

287 
»b®ªû
 = 
NULL
;

289 
»b®ªû
 = 
	`rb_is_bÏck
(
sucûssÜ
è? 
·»Á
 : 
NULL
;

291 
sucûssÜ
->
__rb_·»Á_cŞÜ
 = 
pc
;

292 
tmp
 = 
sucûssÜ
;

295 
augm’t
->
	`´İag©e
(
tmp
, 
NULL
);

296  
»b®ªû
;

297 
	}
}

299 
__®ways_šlše
 

300 
	$rb_”a£_augm’‹d
(
rb_node
 *
node
, 
rb_roÙ
 *
roÙ
,

301 cÚ¡ 
rb_augm’t_ÿÎbacks
 *
augm’t
)

303 
rb_node
 *
»b®ªû
 = 
	`__rb_”a£_augm’‹d
(
node
, 
roÙ
, 
augm’t
);

304 ià(
»b®ªû
)

305 
	`__rb_”a£_cŞÜ
(
»b®ªû
, 
roÙ
, 
augm’t
->
rÙ©e
);

306 
	}
}

308 
__®ways_šlše
 

309 
	$rb_”a£_augm’‹d_ÿched
(
rb_node
 *
node
, 
rb_roÙ_ÿched
 *
roÙ
,

310 cÚ¡ 
rb_augm’t_ÿÎbacks
 *
augm’t
)

312 ià(
roÙ
->
rb_Ëámo¡
 =ğ
node
)

313 
roÙ
->
rb_Ëámo¡
 = 
	`rb_Ãxt
(
node
);

314 
	`rb_”a£_augm’‹d
(
node
, &
roÙ
->
rb_roÙ
, 
augm’t
);

315 
	}
}

	@performance/s-tree/stree.c

40 
	s¡_node
 {

41 
	mhšt
;

42 
¡_node
 *
	m·»Á
;

43 
¡_node
 *
	mËá
, *
	mright
;

46 
	s¡_roÙ
 {

47 
¡_node
 *
	mroÙ
;

50 
	e¡_dœ
 { 
	mLEFT
, 
	mRIGHT
 };

52 
	#¡_roÙ
(
r
èÔ->
roÙ
)

	)

53 
	#¡_Ëá
(
n
èÒ->
Ëá
)

	)

54 
	#¡_right
(
n
èÒ->
right
)

	)

55 
	#¡_½¬’t
(
n
è(
	`¡_right
Ò)->
·»Á
)

	)

56 
	#¡_Í¬’t
(
n
è(
	`¡_Ëá
Ò)->
·»Á
)

	)

57 
	#¡_·»Á
(
n
èÒ->
·»Á
)

	)

59 
¡_node
 *
	$¡_fœ¡
(
¡_node
 *
n
)

61 ià(!
	`¡_Ëá
(
n
))

62  
n
;

64  
	`¡_fœ¡
(
	`¡_Ëá
(
n
));

65 
	}
}

67 
¡_node
 *
	$¡_Ï¡
(
¡_node
 *
n
)

69 ià(!
	`¡_right
(
n
))

70  
n
;

72  
	`¡_Ï¡
(
	`¡_right
(
n
));

73 
	}
}

75 
šlše
 
	$¡_rÙ©e_Ëá
(
¡_node
 *
n
)

77 
¡_node
 *
l
 = 
	`¡_Ëá
(
n
), *
p
 = 
	`¡_·»Á
(n);

79 
	`¡_·»Á
(
l
èğ¡_·»Á(
n
);

80 
	`¡_Ëá
(
n
èğ
	`¡_right
(
l
);

81 
	`¡_·»Á
(
n
èğ
l
;

82 
	`¡_right
(
l
èğ
n
;

84 ià(
p
 && 
	`¡_Ëá
Õè=ğ
n
)

85 
	`¡_Ëá
(
p
èğ
l
;

86 ià(
p
)

87 
	`¡_right
(
p
èğ
l
;

89 ià(
	`¡_Ëá
(
n
))

90 
	`¡_Í¬’t
(
n
) =‚;

91 
	}
}

93 
šlše
 
	$¡_rÙ©e_right
(
¡_node
 *
n
)

95 
¡_node
 *
r
 = 
	`¡_right
(
n
), *
p
 = 
	`¡_·»Á
(n);

97 
	`¡_·»Á
(
r
èğ¡_·»Á(
n
);

98 
	`¡_right
(
n
èğ
	`¡_Ëá
(
r
);

99 
	`¡_·»Á
(
n
èğ
r
;

100 
	`¡_Ëá
(
r
èğ
n
;

102 ià(
p
 && 
	`¡_Ëá
Õè=ğ
n
)

103 
	`¡_Ëá
(
p
èğ
r
;

104 ià(
p
)

105 
	`¡_right
(
p
èğ
r
;

107 ià(
	`¡_right
(
n
))

108 
	`¡_½¬’t
(
n
) =‚;

109 
	}
}

111 
šlše
 
	$¡_b®ªû
(
¡_node
 *
n
)

113 
l
 = 0, 
r
 = 0;

115 ià(
	`¡_Ëá
(
n
))

116 
l
 = 
	`¡_Ëá
(
n
)->
hšt
 + 1;

118 ià(
	`¡_right
(
n
))

119 
r
 = 
	`¡_right
(
n
)->
hšt
 + 1;

121  
l
 - 
r
;

122 
	}
}

124 
šlše
 
	$¡_max_hšt
(
¡_node
 *
n
)

126 
l
 = 0, 
r
 = 0;

128 ià(
	`¡_Ëá
(
n
))

129 
l
 = 
	`¡_Ëá
(
n
)->
hšt
 + 1;

131 ià(
	`¡_right
(
n
))

132 
r
 = 
	`¡_right
(
n
)->
hšt
 + 1;

134  
l
 > 
r
 ?† :„;

135 
	}
}

137 
šlše
 
	$¡_upd©e
(
¡_node
 **
roÙ
, ¡_nod*
n
)

139 ià(!
n
)

142 
b
 = 
	`¡_b®ªû
(
n
);

143 
´ev_hšt
 = 
n
->
hšt
;

144 
¡_node
 *
p
 = 
	`¡_·»Á
(
n
);

146 ià(
b
 < -1) {

148 ià(
n
 =ğ*
roÙ
)

149 *
roÙ
 = 
	`¡_right
(
n
);

150 
	`¡_rÙ©e_right
(
n
);

153 ià(
b
 > 1) {

155 ià(
n
 =ğ*
roÙ
)

156 *
roÙ
 = 
	`¡_Ëá
(
n
);

157 
	`¡_rÙ©e_Ëá
(
n
);

160 
n
->
hšt
 = 
	`¡_max_hšt
(n);

161 ià(
n
->
hšt
 =ğ0 ||‚->hšˆ!ğ
´ev_hšt
)

162 
	`¡_upd©e
(
roÙ
, 
p
);

163 
	}
}

170 
	$¡_š£¹
(
¡_node
 **
roÙ
,

171 
¡_node
 *
p
,

172 
¡_node
 *
n
,

173 
¡_dœ
 
d
)

175 ià(
d
 =ğ
LEFT
)

176 
	`¡_Ëá
(
p
èğ
n
;

178 
	`¡_right
(
p
èğ
n
;

180 
	`¡_·»Á
(
n
èğ
p
;

181 
	`¡_upd©e
(
roÙ
, 
n
);

182 
	}
}

184 
šlše
 
	$¡_»¶aû_right
(
¡_node
 *
n
, ¡_nod*
r
)

186 
¡_node
 *
p
 = 
	`¡_·»Á
(
n
), *
½
 = st_·»Á(
r
);

188 ià(
	`¡_Ëá
(
½
è=ğ
r
) {

189 
	`¡_Ëá
(
½
èğ
	`¡_right
(
r
);

190 ià(
	`¡_right
(
r
))

191 
	`¡_½¬’t
(
r
èğ
½
;

194 ià(
	`¡_·»Á
(
½
è=ğ
n
)

195 
	`¡_·»Á
(
½
èğ
r
;

197 
	`¡_·»Á
(
r
èğ
p
;

198 
	`¡_Ëá
(
r
èğ¡_Ëá(
n
);

200 ià(
	`¡_right
(
n
è!ğ
r
) {

201 
	`¡_right
(
r
èğ¡_right(
n
);

202 
	`¡_½¬’t
(
n
èğ
r
;

205 ià(
p
 && 
	`¡_Ëá
Õè=ğ
n
)

206 
	`¡_Ëá
(
p
èğ
r
;

207 ià(
p
)

208 
	`¡_right
(
p
èğ
r
;

210 ià(
	`¡_Ëá
(
n
))

211 
	`¡_Í¬’t
(
n
èğ
r
;

212 
	}
}

214 
šlše
 
	$¡_»¶aû_Ëá
(
¡_node
 *
n
, ¡_nod*
l
)

216 
¡_node
 *
p
 = 
	`¡_·»Á
(
n
), *
Í
 = st_·»Á(
l
);

218 ià(
	`¡_right
(
Í
è=ğ
l
) {

219 
	`¡_right
(
Í
èğ
	`¡_Ëá
(
l
);

220 ià(
	`¡_Ëá
(
l
))

221 
	`¡_Í¬’t
(
l
èğ
Í
;

224 ià(
	`¡_·»Á
(
Í
è=ğ
n
)

225 
	`¡_·»Á
(
Í
èğ
l
;

227 
	`¡_·»Á
(
l
èğ
p
;

228 
	`¡_right
(
l
èğ¡_right(
n
);

230 ià(
	`¡_Ëá
(
n
è!ğ
l
) {

231 
	`¡_Ëá
(
l
èğ¡_Ëá(
n
);

232 
	`¡_Í¬’t
(
n
èğ
l
;

235 ià(
p
 && 
	`¡_Ëá
Õè=ğ
n
)

236 
	`¡_Ëá
(
p
èğ
l
;

237 ià(
p
)

238 
	`¡_right
(
p
èğ
l
;

240 ià(
	`¡_right
(
n
))

241 
	`¡_½¬’t
(
n
èğ
l
;

242 
	}
}

260 
	$¡_»move
(
¡_node
 **
roÙ
, ¡_nod*
d–
)

262 ià(
	`¡_right
(
d–
)) {

263 
¡_node
 *
Ëa¡
 = 
	`¡_fœ¡
(
	`¡_right
(
d–
));

264 ià(
d–
 =ğ*
roÙ
)

265 *
roÙ
 = 
Ëa¡
;

267 
	`¡_»¶aû_right
(
d–
, 
Ëa¡
);

268 
	`¡_upd©e
(
roÙ
, 
	`¡_right
(
Ëa¡
));

272 ià(
	`¡_Ëá
(
d–
)) {

273 
¡_node
 *
mo¡
 = 
	`¡_Ï¡
(
	`¡_Ëá
(
d–
));

274 ià(
d–
 =ğ*
roÙ
)

275 *
roÙ
 = 
mo¡
;

277 
	`¡_»¶aû_Ëá
(
d–
, 
mo¡
);

278 
	`¡_upd©e
(
roÙ
, 
	`¡_Ëá
(
mo¡
));

282 ià(
d–
 =ğ*
roÙ
) {

283 *
roÙ
 = 0;

288 
¡_node
 *
·»Á
 = 
	`¡_·»Á
(
d–
);

290 ià(
	`¡_Ëá
(
·»Á
è=ğ
d–
)

291 
	`¡_Ëá
(
·»Á
) = 0;

293 
	`¡_right
(
·»Á
) = 0;

295 
	`¡_upd©e
(
roÙ
, 
·»Á
);

296 
	}
}

300 
	~<as£¹.h
>

301 
	~<¡ddef.h
>

302 
	~<¡dio.h
>

303 
	~<¡dlib.h
>

304 
	~<time.h
>

306 
	#cÚš”_of
(
±r
, 
ty³
, 
memb”
) \

307 ((
ty³
 *è((*è(
±r
è- (
	`off£tof
Ñy³, 
memb”
))))

	)

309 
	#Œ“št_’Œy
(
±r
è
	`cÚš”_of
ÕŒ, 
Œ“št
, 
¡_n
)

	)

311 
	sŒ“št
 {

312 
	mv®ue
;

313 
¡_node
 
	m¡_n
;

316 
¡_roÙ
 *
	gŒ“
;

318 
	$Œ“št_š™
()

320 
Œ“
 = 
	`ÿÎoc
((
¡_roÙ
), 1);

321 
	`as£¹
(
Œ“
);

323 
	}
}

325 
	$__Œ“št_de¡roy
(
¡_node
 *
n
)

327 ià(
	`¡_Ëá
(
n
))

328 
	`__Œ“št_de¡roy
(
	`¡_Ëá
(
n
));

330 ià(
	`¡_right
(
n
))

331 
	`__Œ“št_de¡roy
(
	`¡_right
(
n
));

333 
Œ“št
 *
i
 = 
	`Œ“št_’Œy
(
n
);

334 
	`ä“
(
i
);

335 
	}
}

337 
	$Œ“št_de¡roy
()

339 
	`as£¹
(
Œ“
);

340 ià(
	`¡_roÙ
(
Œ“
))

341 
	`__Œ“št_de¡roy
(
	`¡_roÙ
(
Œ“
));

343 
	`ä“
(
Œ“
);

345 
	}
}

347 
Œ“št
 *
	$Œ“št_š£¹
(
a
)

349 
¡_node
 *
p
 = 
NULL
;

350 
¡_dœ
 
d
;

351 
¡_node
 *
n
 = 
	`¡_roÙ
(
Œ“
);‚;) {

352 
Œ“št
 *
t
 = 
	`cÚš”_of
(
n
, Œ“št, 
¡_n
);

353 ià(
a
 =ğ
t
->
v®ue
)

354  
t
;

356 
p
 = 
n
;

358 ià(
a
 < 
t
->
v®ue
) {

359 
n
 = 
	`¡_Ëá
(n);

360 
d
 = 
LEFT
;

361 } ià(
a
 > 
t
->
v®ue
) {

362 
n
 = 
	`¡_right
(n);

363 
d
 = 
RIGHT
;

367 
Œ“št
 *
i
 = 
	`ÿÎoc
((treeint), 1);

368 ià(
	`¡_roÙ
(
Œ“
))

369 
	`¡_š£¹
(&
	`¡_roÙ
(
Œ“
), 
p
, &
i
->
¡_n
, 
d
);

371 
	`¡_roÙ
(
Œ“
èğ&
i
->
¡_n
;

373 
i
->
v®ue
 = 
a
;

374  
i
;

375 
	}
}

377 
Œ“št
 *
	$Œ“št_fšd
(
a
)

379 
¡_node
 *
n
 = 
	`¡_roÙ
(
Œ“
);

380 
n
) {

381 
Œ“št
 *
t
 = 
	`Œ“št_’Œy
(
n
);

382 ià(
a
 =ğ
t
->
v®ue
)

383  
t
;

385 ià(
a
 < 
t
->
v®ue
)

386 
n
 = 
	`¡_Ëá
(n);

387 ià(
a
 > 
t
->
v®ue
)

388 
n
 = 
	`¡_right
(n);

392 
	}
}

394 
	$Œ“št_»move
(
a
)

396 
Œ“št
 *
n
 = 
	`Œ“št_fšd
(
a
);

397 ià(!
n
)

400 
	`¡_»move
(&
	`¡_roÙ
(
Œ“
), &
n
->
¡_n
);

401 
	`ä“
(
n
);

403 
	}
}

406 
	$__Œ“št_dump
(
¡_node
 *
n
, 
d•th
)

408 ià(!
n
)

411 
	`__Œ“št_dump
(
	`¡_Ëá
(
n
), 
d•th
 + 1);

413 
Œ“št
 *
v
 = 
	`Œ“št_’Œy
(
n
);

414 
	`´štf
("%d\n", 
v
->
v®ue
);

416 
	`__Œ“št_dump
(
	`¡_right
(
n
), 
d•th
 + 1);

417 
	}
}

419 
	$Œ“št_dump
()

421 
	`__Œ“št_dump
(
	`¡_roÙ
(
Œ“
), 0);

422 
	}
}

424 
	$maš
()

426 
	`¤ªd
(
	`time
(0));

428 
	`Œ“št_š™
();

435 
i
 = 0; i < 100; ++i)

436 
	`Œ“št_š£¹
(
	`¿nd
() % 99);

438 
	`´štf
("[ After insertions ]\n");

439 
	`Œ“št_dump
();

441 
	`´štf
("Removing...\n");

442 
i
 = 0; i < 100; ++i) {

443 
v
 = 
	`¿nd
() % 99;

444 
	`´štf
("%2d ", 
v
);

445 ià((
i
 + 1) % 10 == 0)

446 
	`´štf
("\n");

447 
	`Œ“št_»move
(
v
);

449 
	`´štf
("\n");

451 
	`´štf
("[ After„emovals ]\n");

452 
	`Œ“št_dump
();

454 
	`Œ“št_de¡roy
();

457 
	}
}

	@performance/strlen/main.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~"¡¾’.h
"

4 
	~<time.h
>

6 
	#TEST_CNT
 1000000

	)

9 
	#EXPECT
(
ex´
) \

11 ià(!(
ex´
)) { \

12 
	`´štf
("Test failed\n"); \

13 
	`ex™
(1); \

15 } 0)

	)

17 
	$d¿wProg»ssB¬
(
´og»ss
, 
tÙ®
) {

18 
b¬Width
 = 50;

19 
³rûÁage
 = ()
´og»ss
 / 
tÙ®
;

20 
numB¬s
 = 
³rûÁage
 * 
b¬Width
;

22 
	`´štf
("[");

23 
i
 = 0; i < 
numB¬s
; i++) {

24 
	`´štf
("=");

26 
i
 = 
numB¬s
; i < 
b¬Width
; i++) {

27 
	`´štf
(" ");

29 
	`´štf
("] %.1f%%\r", 
³rûÁage
 * 100);

30 
	`fæush
(
¡dout
);

31 
	}
}

33 
	$maš
() {

34 
FILE
 *
log_fe
 = 
	`fİ’
("strlen_perf.log", "w");

35 ià(!
log_fe
) {

36 
	`³¼Ü
("Failedo open†og file");

37 
	`ex™
(1);

40 
Ën
 = 1;†’ <ğ
TEST_CNT
;†en++) {

41 *
¡r
 = (*)
	`m®loc
(
Ën
 + 1);

42 
i
 = 0; i < 
Ën
; i++) {

43 
¡r
[
i
] = 'A';

45 
¡r
[
Ën
] = '\0';

47 
time¥ec
 
¡¬t_time
, 
’d_time
;

48 
–­£d_time
;

51 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
¡¬t_time
);

52 
	`EXPECT
(
Ën
 =ğ
	`¡¾’_c
(
¡r
));

53 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
’d_time
);

54 
–­£d_time
 = (
’d_time
.
tv_£c
 - 
¡¬t_time
.tv_sec) +

55 (
’d_time
.
tv_n£c
 - 
¡¬t_time
.tv_nsec) / 1e9;

56 
	`årštf
(
log_fe
, "%d %Îf", 
Ën
, 
–­£d_time
);

58 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
¡¬t_time
);

59 
	`EXPECT
(
Ën
 =ğ
	`¡¾’_gcc
(
¡r
));

60 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
’d_time
);

62 
–­£d_time
 = (
’d_time
.
tv_£c
 - 
¡¬t_time
.tv_sec) +

63 (
’d_time
.
tv_n£c
 - 
¡¬t_time
.tv_nsec) / 1e9;

64 
	`årštf
(
log_fe
, " %Îf\n", 
–­£d_time
);

66 
	`ä“
(
¡r
);

68 
	`d¿wProg»ssB¬
(
Ën
, 
TEST_CNT
);

71 
	`fşo£
(
log_fe
);

73 
	}
}

	@performance/strlen/strlen.c

1 
	~"¡¾’.h
"

3 
size_t
 
	$¡¾’_c
(cÚ¡ *
¡r
) {

4 
size_t
 
Ëngth
 = 0;

5 
¡r
[
Ëngth
] != '\0') {

6 
Ëngth
++;

8  
Ëngth
;

9 
	}
}

11 
size_t
 
	$¡¾’_gcc
 (cÚ¡ *
¡r
)

13 cÚ¡ *
ch¬_±r
;

14 cÚ¡ *
lÚgwÜd_±r
;

15 
lÚgwÜd
, 
himagic
, 
lomagic
;

18 
ch¬_±r
 = 
¡r
; (() char_ptr

19 & ( (
lÚgwÜd
) - 1)) != 0;

20 ++
ch¬_±r
)

21 ià(*
ch¬_±r
 == '\0')

22  
ch¬_±r
 - 
¡r
;

25 
lÚgwÜd_±r
 = (*è
ch¬_±r
;

33 
himagic
 = 0x80808080L;

34 
lomagic
 = 0x01010101L;

35 ià( (
lÚgwÜd
) > 4)

39 
himagic
 = ((himagic << 16) << 16) | himagic;

40 
lomagic
 = ((lomagic << 16) << 16) |†omagic;

43 ià( (
lÚgwÜd
) > 8)

44 
	`abÜt
 ();

50 
lÚgwÜd
 = *
lÚgwÜd_±r
++;

51 ià(((
lÚgwÜd
 - 
lomagic
è& ~lÚgwÜd & 
himagic
) != 0)

55 cÚ¡ *
ı
 = (cÚ¡ *è(
lÚgwÜd_±r
 - 1);

56 ià(
ı
[0] == 0)

57  
ı
 - 
¡r
;

58 ià(
ı
[1] == 0)

59  
ı
 - 
¡r
 + 1;

60 ià(
ı
[2] == 0)

61  
ı
 - 
¡r
 + 2;

62 ià(
ı
[3] == 0)

63  
ı
 - 
¡r
 + 3;

64 ià( (
lÚgwÜd
) > 4)

66 ià(
ı
[4] == 0)

67  
ı
 - 
¡r
 + 4;

68 ià(
ı
[5] == 0)

69  
ı
 - 
¡r
 + 5;

70 ià(
ı
[6] == 0)

71  
ı
 - 
¡r
 + 6;

72 ià(
ı
[7] == 0)

73  
ı
 - 
¡r
 + 7;

77 
	}
}

	@performance/strlen/strlen.h

1 #iâdeà
__STRLEN_H__


2 
	#__STRLEN_H__


	)

4 
	~<¡dlib.h
>

6 
size_t
 
¡¾’_c
(cÚ¡ *
¡r
);

7 
size_t
 
¡¾’_gcc
(cÚ¡ *
¡r
);

	@performance/sve/matrix/main.c

1 
	~<¡dio.h
>

2 
	~<¡dšt.h
>

3 
	~<¡dlib.h
>

4 
	~<¡dboŞ.h
>

5 
	~<m©h.h
>

7 
	tæßt32_t
;

9 
	#BLOCK_SIZE
 4

	)

10 
	#LOOP
 10000

	)

12 
	$m©rix_muÉly_c
(
æßt32_t
 *
A
, flßt32_ˆ*
B
, flßt32_ˆ*
C
, 
ušt32_t
 
n
, ušt32_ˆ
m
, ušt32_ˆ
k
)

14 
i_idx
 = 0; i_idx < 
n
; i_idx++)

16 
j_idx
 = 0; j_idx < 
m
; j_idx++)

18 
C
[
n
 * 
j_idx
 + 
i_idx
] = 0;

19 
k_idx
 = 0; k_idx < 
k
; k_idx++)

21 
C
[
n
 * 
j_idx
 + 
i_idx
] +ğ
A
[À* 
k_idx
 + i_idx] * 
B
[
k
 * j_idx + k_idx];

25 
	}
}

27 
	$m©rix_muÉly_4x4_asm
(
æßt32_t
 *
A
, flßt32_ˆ*
B
, flßt32_ˆ*
C
)

29 
asm
 volatile(

82 : [
a
] "r"(
A
), [
b
] "r"(
B
), [
c
] "r"(
C
)

86 
	}
}

88 
	$´št_m©rix
(
æßt32_t
 *
M
, 
ušt32_t
 
cŞs
, ušt32_ˆ
rows
)

90 
i
 = 0; i < 
rows
; i++)

92 
j
 = 0; j < 
cŞs
; j++)

94 
	`´štf
("%à", 
M
[
j
 * 
rows
 + 
i
]);

96 
	`´štf
("\n");

98 
	`´štf
("\n");

99 
	}
}

101 
	$m©rix_š™_¿nd
(
æßt32_t
 *
M
, 
ušt32_t
 
numv®s
)

103 
i
 = 0; i < 
numv®s
; i++)

105 
M
[
i
] = ()
	`¿nd
(è/ ()(
RAND_MAX
);

107 
	}
}

109 
	$m©rix_š™
(
æßt32_t
 *
M
, 
ušt32_t
 
cŞs
, ušt32_ˆ
rows
, flßt32_ˆ
v®
)

111 
i
 = 0; i < 
rows
; i++)

113 
j
 = 0; j < 
cŞs
; j++)

115 
M
[
j
 * 
rows
 + 
i
] = 
v®
;

118 
	}
}

120 
boŞ
 
	$f32comp_nÙeq
(
æßt32_t
 
a
, flßt32_ˆ
b
)

122 ià(
	`çbs
(
a
 - 
b
) < 0.000001)

124  
çl£
;

126  
Œue
;

127 
	}
}

129 
boŞ
 
	$m©rix_comp
(
æßt32_t
 *
A
, flßt32_ˆ*
B
, 
ušt32_t
 
rows
, ušt32_ˆ
cŞs
)

131 
æßt32_t
 
a
;

132 
æßt32_t
 
b
;

133 
i
 = 0; i < 
rows
; i++)

135 
j
 = 0; j < 
cŞs
; j++)

137 
a
 = 
A
[
rows
 * 
j
 + 
i
];

138 
b
 = 
B
[
rows
 * 
j
 + 
i
];

140 ià(
	`f32comp_nÙeq
(
a
, 
b
))

142 
	`´štf
("i=%d, j=%d, A=%f, B=%f\n", 
i
, 
j
, 
a
, 
b
);

143  
çl£
;

147  
Œue
;

148 
	}
}

150 
	$maš
()

152 
i
;

153 
ušt32_t
 
n
 = 
BLOCK_SIZE
;

154 
ušt32_t
 
m
 = 
BLOCK_SIZE
;

155 
ušt32_t
 
k
 = 
BLOCK_SIZE
;

157 
æßt32_t
 
A
[
n
 * 
k
];

158 
æßt32_t
 
B
[
k
 * 
m
];

159 
æßt32_t
 
C
[
n
 * 
m
];

160 
æßt32_t
 
D
[
n
 * 
m
];

162 
boŞ
 
c_eq_asm
;

163 
boŞ
 
c_eq_ÃÚ
;

165 
	`m©rix_š™_¿nd
(
A
, 
n
 * 
k
);

166 
	`m©rix_š™_¿nd
(
B
, 
k
 * 
m
);

167 
	`m©rix_š™
(
C
, 
n
, 
m
, 0);

169 
	`´štf
("A[] data:\n");

170 
	`´št_m©rix
(
A
, 
m
, 
k
);

172 
	`´štf
("B[] data:\n");

173 
	`´št_m©rix
(
B
, 
m
, 
k
);

176 
i
 = 0; i < 
LOOP
; i++)

177 
	`m©rix_muÉly_c
(
A
, 
B
, 
C
, 
n
, 
m
, 
k
);

178 
	`´štf
("C„esult:\n");

179 
	`´št_m©rix
(
C
, 
n
, 
m
);

181 
i
 = 0; i < 
LOOP
; i++)

182 
	`m©rix_muÉly_4x4_asm
(
A
, 
B
, 
D
);

183 
	`´štf
("asm„esult:\n");

184 
	`´št_m©rix
(
D
, 
n
, 
m
);

186 
c_eq_ÃÚ
 = 
	`m©rix_comp
(
C
, 
D
, 
n
, 
m
);

187 
	`´štf
("Asmƒqu®ØC: %s\n", 
c_eq_ÃÚ
 ? "yes" : "no");

188 
	`´štf
("===============================\n");

189 
	}
}

	@
1
.
0
32
1079
algorithm/graph/310.Minimum_Height_Tree/bfs.cpp
algorithm/graph/332.Reconstruct Itinerary/greedy_dfs.cpp
algorithm/graph/399.Evaluate_devision/bfs.cpp
algorithm/graph/399.Evaluate_devision/dfs.cpp
algorithm/graph/547.Number_of_Provinces/bfs.cpp
algorithm/graph/547.Number_of_Provinces/dfs.cpp
algorithm/graph/684.Redundant_Connection/dfs.cpp
algorithm/graph/684.Redundant_Connection/union_find.cpp
features/fs/cp/cp.c
features/fs/ls/ls.c
features/hashtable/hashtable.c
features/hashtable/hashtable.h
features/hashtable/main.c
features/make_config/config.h
features/make_config/main.c
features/malloc/main.c
features/queue/list.h
features/queue/queue.c
performance/neon/matrix/main.c
performance/neon/memcpy/benchmark.c
performance/neon/rgb/main.c
performance/qsort/hsort.c
performance/qsort/isort.c
performance/qsort/qsort.c
performance/s-tree/rbtree/rbtree.c
performance/s-tree/rbtree/rbtree.h
performance/s-tree/rbtree/rbtree_augmented.h
performance/s-tree/stree.c
performance/strlen/main.c
performance/strlen/strlen.c
performance/strlen/strlen.h
performance/sve/matrix/main.c
